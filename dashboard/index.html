<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n L√Ω S·∫£n Xu·∫•t B√°nh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 600px; margin: auto; }
    h2 { margin-top: 30px; }
    label, input, select, textarea, button { display: block; width: 100%; margin: 5px 0; }
    input, select, textarea { padding: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
    .nav { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .nav button { flex: 1; padding: 10px; }
  </style>
</head>
<body>

<h1>üßÅ Qu·∫£n L√Ω S·∫£n Xu·∫•t B√°nh</h1>

<div class="nav">
  <button onclick="showTab('nguyenlieu')">Nguy√™n li·ªáu</button>
  <button onclick="showTab('congthuc')">C√¥ng th·ª©c</button>
  <button onclick="showTab('sanxuat')">S·∫£n xu·∫•t</button>
  <button onclick="showTab('banhang')">B√°n h√†ng</button>
  <button onclick="showTab('baocao')">B√°o c√°o</button>
  <button onclick="saveDataToDrive()">üíæ L∆∞u Drive</button>
  <button onclick="loadDataFromDrive()">üîÑ T·∫£i Drive</button>
</div>

<!-- Tabs -->
<div id="nguyenlieu" class="tab">
  <h2>Nguy√™n li·ªáu</h2>
  <input id="nlTen" placeholder="T√™n nguy√™n li·ªáu">
  <input id="nlSoLuong" type="number" placeholder="S·ªë l∆∞·ª£ng">
  <button onclick="themNguyenLieu()">Th√™m</button>
  <table id="tableNguyenLieu"></table>
</div>

<div id="congthuc" class="tab" style="display:none">
  <h2>C√¥ng th·ª©c</h2>
  <input id="ctTen" placeholder="T√™n b√°nh">
  <textarea id="ctNguyenLieu" placeholder="T√™n1:S·ªë l∆∞·ª£ng, T√™n2:S·ªë l∆∞·ª£ng..."></textarea>
  <button onclick="themCongThuc()">Th√™m</button>
  <table id="tableCongThuc"></table>
</div>

<div id="sanxuat" class="tab" style="display:none">
  <h2>Ghi nh·∫≠n s·∫£n xu·∫•t</h2>
  <select id="sxTenBanh"></select>
  <input id="sxSoLuong" type="number" placeholder="S·ªë l∆∞·ª£ng">
  <button onclick="ghiNhanSanXuat()">Ghi nh·∫≠n</button>
  <table id="tableSanXuat"></table>
</div>

<div id="banhang" class="tab" style="display:none">
  <h2>Ghi nh·∫≠n b√°n h√†ng</h2>
  <select id="bhTenBanh"></select>
  <input id="bhSoLuong" type="number" placeholder="S·ªë l∆∞·ª£ng">
  <button onclick="ghiNhanBanHang()">Ghi nh·∫≠n</button>
  <table id="tableBanHang"></table>
</div>

<div id="baocao" class="tab" style="display:none">
  <h2>T·ªìn kho b√°nh</h2>
  <table id="tableKhoBanh"></table>
</div>

<script>
let nguyenLieu = [];
let congThuc = {};
let lichSanXuat = [];
let banHang = [];
let tonKho = {};

const SERVER_URL = "https://script.google.com/macros/s/AKfycbycRIXX-K3cWgERWZhOacbhRF62mnaCcBnC9_wVldtIkBsDlf9d55ghG8zawpm2gbeAfA/exec"; // üëà Thay b·∫±ng URL Google Apps Script

function showTab(id) {
  document.querySelectorAll('.tab').forEach(tab => tab.style.display = 'none');
  document.getElementById(id).style.display = 'block';
}

function themNguyenLieu() {
  const ten = document.getElementById("nlTen").value.trim();
  const sl = parseInt(document.getElementById("nlSoLuong").value);
  if (!ten || isNaN(sl)) return alert("Nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† s·ªë l∆∞·ª£ng");
  const item = nguyenLieu.find(i => i.ten === ten);
  if (item) item.soluong += sl;
  else nguyenLieu.push({ ten, soluong: sl });
  loadNguyenLieu();
}

function loadNguyenLieu() {
  const table = document.getElementById("tableNguyenLieu");
  table.innerHTML = "<tr><th>T√™n</th><th>S·ªë l∆∞·ª£ng</th></tr>" +
    nguyenLieu.map(i => `<tr><td>${i.ten}</td><td>${i.soluong}</td></tr>`).join("");
}

function themCongThuc() {
  const ten = document.getElementById("ctTen").value.trim();
  const ngl = document.getElementById("ctNguyenLieu").value.trim();
  if (!ten || !ngl) return alert("Nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† nguy√™n li·ªáu");
  const list = ngl.split(",").map(x => {
    const [t, sl] = x.split(":").map(s => s.trim());
    return { ten: t, soluong: parseInt(sl) };
  });
  congThuc[ten] = list;
  loadCongThuc();
  loadBanhSelect();
}

function loadCongThuc() {
  const table = document.getElementById("tableCongThuc");
  table.innerHTML = "<tr><th>T√™n b√°nh</th><th>Nguy√™n li·ªáu</th></tr>" +
    Object.entries(congThuc).map(([ten, ds]) =>
      `<tr><td>${ten}</td><td>${ds.map(i => `${i.ten}:${i.soluong}`).join(", ")}</td></tr>`
    ).join("");
}

function loadBanhSelect() {
  const sx = document.getElementById("sxTenBanh");
  const bh = document.getElementById("bhTenBanh");
  const keys = Object.keys(congThuc);
  sx.innerHTML = bh.innerHTML = keys.map(k => `<option>${k}</option>`).join("");
}

function ghiNhanSanXuat() {
  const ten = document.getElementById("sxTenBanh").value;
  const sl = parseInt(document.getElementById("sxSoLuong").value);
  if (!ten || isNaN(sl)) return alert("Ch·ªçn b√°nh v√† s·ªë l∆∞·ª£ng");
  lichSanXuat.push({ ten, soluong: sl, time: new Date().toISOString() });

  const ds = congThuc[ten];
  ds.forEach(ng => {
    const item = nguyenLieu.find(i => i.ten === ng.ten);
    if (item) item.soluong -= ng.soluong * sl;
  });

  tonKho[ten] = (tonKho[ten] || 0) + sl;

  loadNguyenLieu();
  loadSanXuat();
  loadKhoBanh();
  saveDataToDrive();
}

function loadSanXuat() {
  const table = document.getElementById("tableSanXuat");
  table.innerHTML = "<tr><th>B√°nh</th><th>S·ªë l∆∞·ª£ng</th><th>Th·ªùi gian</th></tr>" +
    lichSanXuat.map(i => `<tr><td>${i.ten}</td><td>${i.soluong}</td><td>${i.time}</td></tr>`).join("");
}

function ghiNhanBanHang() {
  const ten = document.getElementById("bhTenBanh").value;
  const sl = parseInt(document.getElementById("bhSoLuong").value);
  if (!ten || isNaN(sl)) return alert("Ch·ªçn b√°nh v√† s·ªë l∆∞·ª£ng");
  banHang.push({ ten, soluong: sl, time: new Date().toISOString() });
  tonKho[ten] = (tonKho[ten] || 0) - sl;
  loadKhoBanh();
  loadBanHang();
  saveDataToDrive();
}

function loadBanHang() {
  const table = document.getElementById("tableBanHang");
  table.innerHTML = "<tr><th>B√°nh</th><th>S·ªë l∆∞·ª£ng</th><th>Th·ªùi gian</th></tr>" +
    banHang.map(i => `<tr><td>${i.ten}</td><td>${i.soluong}</td><td>${i.time}</td></tr>`).join("");
}

function loadKhoBanh() {
  const table = document.getElementById("tableKhoBanh");
  table.innerHTML = "<tr><th>B√°nh</th><th>T·ªìn kho</th></tr>" +
    Object.entries(tonKho).map(([ten, sl]) =>
      `<tr><td>${ten}</td><td>${sl}</td></tr>`
    ).join("");
}

// ==== Google Drive Functions ====

function saveDataToDrive() {
  const data = {
    nguyenLieu,
    congThuc,
    lichSanXuat,
    banHang
  };
  fetch(SERVER_URL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.text())
  .then(msg => alert("‚úÖ ƒê√£ l∆∞u: " + msg))
  .catch(err => alert("‚ùå L·ªói l∆∞u: " + err));
}

function loadDataFromDrive() {
  fetch(SERVER_URL)
    .then(res => res.json())
    .then(data => {
      nguyenLieu = data.nguyenLieu || [];
      congThuc = data.congThuc || {};
      lichSanXuat = data.lichSanXuat || [];
      banHang = data.banHang || [];

      tonKho = {};
      lichSanXuat.forEach(i => {
        tonKho[i.ten] = (tonKho[i.ten] || 0) + i.soluong;
        const ds = congThuc[i.ten] || [];
        ds.forEach(ng => {
          const item = nguyenLieu.find(k => k.ten === ng.ten);
          if (item) item.soluong -= ng.soluong * i.soluong;
        });
      });
      banHang.forEach(i => tonKho[i.ten] = (tonKho[i.ten] || 0) - i.soluong);

      loadNguyenLieu();
      loadCongThuc();
      loadBanhSelect();
      loadSanXuat();
      loadBanHang();
      loadKhoBanh();
    })
    .catch(err => alert("‚ùå L·ªói t·∫£i d·ªØ li·ªáu: " + err));
}

// Auto load on start
loadDataFromDrive();
</script>

</body>
</html>
