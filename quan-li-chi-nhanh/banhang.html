<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bán hàng - Nhụy Nguyên</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; background: #f4f4f4; max-width: 500px; margin: auto; }
    h2 { color: #333; }
    select, input, button { width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; }
    button { background-color: #28a745; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #218838; }
    .success { color: green; margin-top: 10px; }
    .error { color: red; margin-top: 10px; }
    ul { list-style: none; padding: 0; }
    li { background: white; margin: 5px 0; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>Bán hàng - Chi nhánh <span id="branchLabel"></span></h2>

  <select id="productSelect"></select>
  <input type="number" id="quantityInput" placeholder="Số lượng bán" min="1" />
  <button onclick="submitSale()">Ghi nhận bán hàng</button>

  <div id="message"></div>
  <h3>Lịch sử bán hôm nay:</h3>
  <ul id="saleLog"></ul>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzfd_pHMmc9qGXJ4iT2LYXg78-WSxXVTHr5O0EeGcs5pa4RlZMB2Gs1xETul4XI-hPFTw/exec';
    const PIN = localStorage.getItem('pin');
    let salesData = null;
    let currentBranch = null;

    async function loadData() {
      const res = await fetch(SCRIPT_URL);
      salesData = await res.json();

      const branchName = salesData.pins?.[PIN];
      if (!branchName) return showMessage("Mã PIN không hợp lệ.", true);

      currentBranch = salesData.branches.find(b => b.name === branchName);
      if (!currentBranch) return showMessage("Không tìm thấy chi nhánh.", true);

      document.getElementById('branchLabel').innerText = branchName;
      loadMenu(currentBranch.menu);
      loadLogs(branchName);
    }

    function loadMenu(menu) {
      const select = document.getElementById('productSelect');
      select.innerHTML = '';
      menu.forEach(item => {
        const option = document.createElement('option');
        option.value = item.name;
        option.text = `${item.name} (Còn: ${item.stock})`;
        select.appendChild(option);
      });
    }

    function loadLogs(branchName) {
      const today = new Date().toISOString().split('T')[0];
      const logs = salesData.logs?.filter(log => log.branch === branchName && log.date === today) || [];
      const list = document.getElementById('saleLog');
      list.innerHTML = '';
      logs.forEach(log => {
        const li = document.createElement('li');
        li.innerText = `${log.time}: ${log.item} x${log.quantity}`;
        list.appendChild(li);
      });
    }

    async function submitSale() {
      const item = document.getElementById('productSelect').value;
      const quantity = parseInt(document.getElementById('quantityInput').value);
      if (!item || !quantity || quantity <= 0) return showMessage("Vui lòng nhập thông tin hợp lệ", true);

      // Giảm tồn kho + ghi log
      const now = new Date();
      const log = {
        date: now.toISOString().split('T')[0],
        time: now.toLocaleTimeString('vi-VN'),
        item,
        quantity,
        branch: currentBranch.name
      };

      const product = currentBranch.menu.find(p => p.name === item);
      if (product.stock < quantity) return showMessage("Không đủ tồn kho", true);
      product.stock -= quantity;
      salesData.logs = salesData.logs || [];
      salesData.logs.push(log);

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(salesData),
        mode:'no-cors',
        headers: { 'Content-Type': 'application/json' }
      });

      if (res.ok) {
        showMessage("Đã ghi nhận bán hàng!");
        loadMenu(currentBranch.menu);
        loadLogs(currentBranch.name);
        document.getElementById('quantityInput').value = '';
      } else {
        showMessage("Lỗi khi ghi dữ liệu.", true);
      }
    }

    function showMessage(msg, isError = false) {
      const div = document.getElementById('message');
      div.innerText = msg;
      div.className = isError ? 'error' : 'success';
    }

    loadData();
  </script>
</body>
</html>
