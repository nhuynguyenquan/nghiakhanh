<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω chi nh√°nh Nh·ª•y Nguy√™n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    h1, h2 { color: #2c3e50; }
    .branch { margin-bottom: 30px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    input[type="number"], input[type="text"] { width: 100px; }
    button { padding: 5px 10px; cursor: pointer; }
    .report { margin-top: 10px; font-weight: bold; color: #16a085; }
    .add-form { margin-top: 15px; background: #f1f1f1; padding: 10px; border-radius: 6px; } /* üëà NEW */
  </style>
</head>
<body>

<h1>üîß Qu·∫£n l√Ω Chi Nh√°nh - Nh·ª•y Nguy√™n</h1>
<div id="branchContainer">ƒêang t·∫£i d·ªØ li·ªáu...</div>

<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzfd_pHMmc9qGXJ4iT2LYXg78-WSxXVTHr5O0EeGcs5pa4RlZMB2Gs1xETul4XI-hPFTw/exec://script.google.com/macros/s/XXX/exec'; // Thay b·∫±ng URL c·ªßa b·∫°n
  const TELEGRAM_TOKEN = '7783089403:AAGNpG6GsdlF7VXVfPTW8Y1xQJEqBahL1PY';                         // Thay b·∫±ng token bot
  const CHAT_ID = '6249154937';                                  // Thay b·∫±ng chat_id

  let salesData = { branches: [], logs: [] };

  async function fetchSalesData() {
    try {
      const res = await fetch(SCRIPT_URL);
      salesData = await res.json();
      renderBranches();
    } catch (e) {
      document.getElementById('branchContainer').innerHTML = '‚ùå L·ªói t·∫£i d·ªØ li·ªáu';
      console.error(e);
    }
  }

  async function saveSalesData() {
    await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(salesData),
      mode:'no-cors',
      headers: { "Content-Type": "application/json" }
    });
  }

  async function sendTelegramMessage(message) {
    const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
    await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: CHAT_ID, text: message })
    });
  }

  function renderBranches() {
    const container = document.getElementById('branchContainer');
    container.innerHTML = '';

    salesData.branches.forEach((branch, index) => {
      const branchDiv = document.createElement('div');
      branchDiv.className = 'branch';

      branchDiv.innerHTML = `
        <h2>${branch.name}</h2>
        <table>
          <thead>
            <tr>
              <th>M√≥n</th>
              <th>T·ªìn kho</th>
              <th>Gi√°</th>
              <th>S·ªë l∆∞·ª£ng b√°n</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
            ${branch.menu.map((item, i) => `
              <tr>
                <td>${item.name}</td>
                <td id="stock-${index}-${i}">${item.stock}</td>
                <td>${item.price.toLocaleString()}‚Ç´</td>
                <td><input type="number" id="qty-${index}-${i}" min="1" max="${item.stock}" /></td>
                <td><button onclick="sellItem(${index}, ${i})">B√°n</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        <!-- üëá NEW: Form th√™m s·∫£n ph·∫©m -->
        <div class="add-form">
          <h4>‚ûï Th√™m m√≥n m·ªõi</h4>
          <input type="text" id="new-name-${index}" placeholder="T√™n m√≥n" />
          <input type="number" id="new-stock-${index}" placeholder="T·ªìn kho" />
          <input type="number" id="new-price-${index}" placeholder="Gi√°" />
          <button onclick="addItem(${index})">Th√™m m√≥n</button>
        </div>

        <div class="report" id="report-${index}">ƒêang th·ªëng k√™...</div>
      `;

      container.appendChild(branchDiv);
    });

    salesData.branches.forEach((b, i) => generateReport(i));
  }

  function generateReport(branchIndex) {
    const branch = salesData.branches[branchIndex];
    const logs = salesData.logs.filter(log => log.branch === branch.name);
    const reportDiv = document.getElementById(`report-${branchIndex}`);

    let totalRevenue = 0, totalItems = 0;
    logs.forEach(log => {
      const item = branch.menu.find(i => i.name === log.item);
      if (item) {
        totalRevenue += item.price * log.quantity;
        totalItems += log.quantity;
      }
    });

    reportDiv.innerHTML = `üìä Doanh thu: ${totalRevenue.toLocaleString()}‚Ç´ ‚Äì T·ªïng s·ªë m√≥n b√°n: ${totalItems}`;
  }

  async function sellItem(branchIndex, itemIndex) {
    const qtyInput = document.getElementById(`qty-${branchIndex}-${itemIndex}`);
    const quantity = parseInt(qtyInput.value);

    if (!quantity || quantity <= 0) {
      alert("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá.");
      return;
    }

    const item = salesData.branches[branchIndex].menu[itemIndex];
    if (quantity > item.stock) {
      alert("Kh√¥ng ƒë·ªß h√†ng t·ªìn kho.");
      return;
    }

    item.stock -= quantity;
    document.getElementById(`stock-${branchIndex}-${itemIndex}`).textContent = item.stock;
    qtyInput.value = '';

    const log = {
      branch: salesData.branches[branchIndex].name,
      item: item.name,
      quantity: quantity,
      time: new Date().toISOString()
    };
    salesData.logs.push(log);

    await saveSalesData();
    await sendTelegramMessage(`üì¶ ƒê√£ b√°n ${quantity} x ${item.name} t·∫°i ${log.branch} l√∫c ${new Date().toLocaleTimeString()}`);
    generateReport(branchIndex);

    alert(`‚úÖ ƒê√£ b√°n ${quantity} ${item.name}`);
  }

  // üëá NEW: H√†m th√™m s·∫£n ph·∫©m
  async function addItem(branchIndex) {
    const name = document.getElementById(`new-name-${branchIndex}`).value.trim();
    const stock = parseInt(document.getElementById(`new-stock-${branchIndex}`).value);
    const price = parseInt(document.getElementById(`new-price-${branchIndex}`).value);

    if (!name || isNaN(stock) || isNaN(price) || stock <= 0 || price <= 0) {
      alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† h·ª£p l·ªá.");
      return;
    }

    salesData.branches[branchIndex].menu.push({ name, stock, price });
    await saveSalesData();
    alert(`‚úÖ ƒê√£ th√™m m√≥n ${name}`);
    fetchSalesData(); // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
  }

  fetchSalesData();
</script>

</body>
</html>
