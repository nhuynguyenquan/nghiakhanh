<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản Lý Chi Nhánh</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">Quản Lý Chi Nhánh</h1>

    <div class="mb-4 flex flex-wrap gap-2">
      <select id="branchSelect" class="p-2 border rounded">
        <option value="">Chọn chi nhánh</option>
      </select>
      <input type="date" id="dateInput" class="p-2 border rounded">
      <button onclick="loadBranchData()" class="bg-blue-500 text-white px-4 py-2 rounded">Xem</button>
    </div>

    <div id="stockSection" class="bg-white shadow rounded p-4 mb-4 hidden">
      <h2 class="text-lg font-semibold mb-2">Tồn kho hiện tại</h2>
      <table class="w-full border">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2 py-1">Sản phẩm</th>
            <th class="border px-2 py-1">Tồn kho</th>
            <th class="border px-2 py-1">Đơn giá</th>
          </tr>
        </thead>
        <tbody id="stockTable"></tbody>
      </table>
    </div>

    <div id="salesSection" class="bg-white shadow rounded p-4 hidden">
      <h2 class="text-lg font-semibold mb-2">Doanh thu ngày <span id="salesDate"></span></h2>
      <table class="w-full border">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2 py-1">Sản phẩm</th>
            <th class="border px-2 py-1">Đã bán</th>
            <th class="border px-2 py-1">Tổng</th>
          </tr>
        </thead>
        <tbody id="salesTable"></tbody>
        <tfoot>
          <tr class="font-bold bg-gray-100">
            <td colspan="2" class="text-right border px-2 py-1">Tổng cộng</td>
            <td class="border px-2 py-1 text-center" id="totalRevenue"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script>
    const fileUrl = 'https://script.google.com/macros/s/AKfycbzYtwJVS62FPuAnIEikE-sgvt_bh_aV5qkepv5aU4jYFs2hOlSQKzJwu-orNkLqNMwZxA/exec'; 

    async function fetchData() {
  const res = await fetch(API_URL);
  return await res.json();
}
async function saveData() {
    await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(data),
      mode: "no-cors",
      headers: { 'Content-Type': 'application/json' }
    });
  }


    async function loadBranchOptions() {
      const data = await fetchData();
      const select = document.getElementById('branchSelect');
      for (const branch in data.branches) {
        const opt = document.createElement('option');
        opt.value = branch;
        opt.textContent = branch;
        select.appendChild(opt);
      }
    }

    async function loadBranchData() {
      const data = await fetchData();
      const branchName = document.getElementById('branchSelect').value;
      const date = document.getElementById('dateInput').value;
      if (!branchName || !date) return alert('Vui lòng chọn chi nhánh và ngày.');

      const branch = data.branches[branchName];

      // Hiển thị tồn kho
      document.getElementById('stockSection').classList.remove('hidden');
      const stockTable = document.getElementById('stockTable');
      stockTable.innerHTML = '';
      branch.stock.forEach(item => {
        stockTable.innerHTML += `
          <tr>
            <td class="border px-2 py-1">${item.name}</td>
            <td class="border px-2 py-1 text-center">${item.stock}</td>
            <td class="border px-2 py-1 text-right">${Number(item.price).toLocaleString()}</td>
          </tr>`;
      });

      // Hiển thị doanh thu
      const log = branch.logs.find(log => log.date === date);
      const salesTable = document.getElementById('salesTable');
      const salesDate = document.getElementById('salesDate');
      const totalRevenue = document.getElementById('totalRevenue');
      salesDate.textContent = date;
      salesTable.innerHTML = '';
      let total = 0;

      if (log) {
        document.getElementById('salesSection').classList.remove('hidden');
        log.sales.forEach(sale => {
          total += sale.total;
          salesTable.innerHTML += `
            <tr>
              <td class="border px-2 py-1">${sale.name}</td>
              <td class="border px-2 py-1 text-center">${sale.quantity}</td>
              <td class="border px-2 py-1 text-right">${Number(sale.total).toLocaleString()}</td>
            </tr>`;
        });
      } else {
        document.getElementById('salesSection').classList.remove('hidden');
        salesTable.innerHTML = '<tr><td colspan="3" class="text-center py-2">Không có dữ liệu bán hàng.</td></tr>';
      }

      totalRevenue.textContent = total.toLocaleString();
    }

    loadBranchOptions();
  </script>
</body>
</html>
