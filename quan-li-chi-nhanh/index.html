<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Qu·∫£n l√Ω b√°n h√†ng Nh·ª•y Nguy√™n</title>
<style>
  /* Fix iOS font scaling */
  html {
    -webkit-text-size-adjust: 100%;
    -moz-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }

  /* Font th√¢n thi·ªán iOS + Android */
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 16px;
    line-height: 1.4;
    background: #f4f4f4;
    padding: 1rem;
    margin: 0;
  }
  h1, h2, h3 { color: #2c3e50; }
  .branch { background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
  th { background: #f0f0f0; }
  input, button, select { padding: 6px; margin: 2px; }
  .form-group { margin-top: 10px; }
  @media (max-width: 768px) {
    table, thead, tbody, th, td, tr { display: block; }
    td { border: none; padding: 4px 0; }
  }
  nav {
    display: flex;
    justify-content: center;
    background-color: #d9a382;
    padding: 10px;
  }
  nav a {
    color: white;
    text-decoration: none;
    margin: 0 15px;
    font-size: 18px;
  }
  .month-section { border: 1px solid #ccc; border-radius: 6px; margin: 1rem 0; background: white; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .month-header { padding: 10px; background: #d9a382; color: white; cursor: pointer; font-weight: bold; }
  .month-content { display: none; padding: 10px; overflow-x: auto; }
  .month-content table { width: 100%; border-collapse: collapse; min-width: 600px; }
  .month-content th, .month-content td { padding: 6px 8px; text-align: left; white-space: nowrap; border: 1px solid #ddd; }
  @media (max-width: 600px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }
  thead {
    display: none;
  }
  tr {
    margin-bottom: 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px;
    background: white;
  }
  td {
    position: relative;
    padding-left: 50%;
    border: none;
    border-bottom: 1px solid #eee;
    text-align: left; /* M·∫∑c ƒë·ªãnh canh tr√°i */
    white-space: normal;
  }
  td.numeric {
    text-align: right; /* C·ªôt s·ªë li·ªáu canh ph·∫£i */
  }
  td::before {
    position: absolute;
    left: 10px;
    top: 10px;
    width: 45%;
    white-space: nowrap;
    font-weight: bold;
    text-align: left;
    content: attr(data-label);
  }
  input, button, select {
    width: 100%;
    box-sizing: border-box;
    margin: 4px 0;
    font-size: 1rem;
  }
  .form-group {
    margin-top: 8px;
  }
}
</style>

<link rel="manifest" href="../quan-li/manifest.json">
<meta name="theme-color" content="#4CAF50">
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data && event.data.type === 'NEW_VERSION_AVAILABLE') {
      if (confirm("C√≥ phi√™n b·∫£n m·ªõi c·ªßa ·ª©ng d·ª•ng. B·∫°n c√≥ mu·ªën t·∫£i l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t?")) {
        window.location.reload();
      }
    }
  });
}
</script>
</head>
<nav>
  <a href="../quan-li-thu-chi/">Qu·∫£n L√≠ Thu Chi</a>
  <a href="../quan-li-kho/">Qu·∫£n L√≠ kho</a>
  <a href="../quan-li-menu/">Qu·∫£n L√≠ Menu</a>
  <a href="../quan-li-nv">Qu·∫£n l√≠ nh√¢n vi√™n</a>
  <a href="../quan-li-sx">Qu·∫£n l√≠ s·∫£n xu·∫•t</a>
  <a href="../quan-li-chi-nhanh/">Qu·∫£n L√≠ Chi Nh√°nh</a>
</nav>
<body>

<h1>üìä Qu·∫£n l√Ω b√°n h√†ng - Nh·ª•y Nguy√™n</h1>
<div>
  <h2>üìà B√°o c√°o t·ªïng h·ª£p</h2>
  <div id="report"></div>
</div>
<div>
  <h2>‚ûï Th√™m chi nh√°nh m·ªõi</h2>
  <input id="newBranchName" placeholder="T√™n chi nh√°nh">
  <button onclick="addBranch()">Th√™m chi nh√°nh</button>
</div>

<hr>

<div>
  <label>L·ªçc theo ng√†y: <input type="date" id="filterDate" onchange="renderBranches()"></label>
</div>

<hr>

<div id="branches"></div>

<script src="../auth.js"></script>
<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzfd_pHMmc9qGXJ4iT2LYXg78-WSxXVTHr5O0EeGcs5pa4RlZMB2Gs1xETul4XI-hPFTw/exec';
const TELEGRAM_TOKEN = '7783089403:AAGNpG6GsdlF7VXVfPTW8Y1xQJEqBahL1PY';
const CHAT_ID = '6249154937';

let salesData = { branches: [], logs: [] };

async function fetchSalesData() {
  const res = await fetch(SCRIPT_URL);
  salesData = await res.json();
  renderBranches();
  renderReport();
}

function getFilterDate() {
  return document.getElementById('filterDate').value;
}

function renderBranches() {
  const container = document.getElementById('branches');
  container.innerHTML = '';

  salesData.branches.forEach((branch, bIndex) => {
    const div = document.createElement('div');
    div.className = 'branch';

    let html = `
      <h2>${branch.name}</h2>
      <div>
        <label>M√£ PIN: 
          <input type="password" id="pin-${bIndex}" value="${branch.pin || ''}" onchange="editPin(${bIndex}, this.value)">
        </label>
        <button onclick="togglePin(${bIndex})">üëÅÔ∏è</button>
      </div>
    `;

    html += `<table><tr><th>M√≥n</th><th>ƒê∆°n v·ªã</th><th>T·ªìn kho</th><th>Gi√°</th><th>B√°n</th><th></th></tr>`;
    branch.menu.forEach((item, iIndex) => {
      html += `<tr>
        <td><input value="${item.name}" onchange="editItem(${bIndex}, ${iIndex}, 'name', this.value)"></td>
        <td><input value="${item.unit || ''}" onchange="editItem(${bIndex}, ${iIndex}, 'unit', this.value)"></td>
        <td><input type="number" value="${item.stock}" onchange="editItem(${bIndex}, ${iIndex}, 'stock', this.value)"></td>
        <td><input type="number" value="${item.price}" onchange="editItem(${bIndex}, ${iIndex}, 'price', this.value)"></td>
        <td><input type="number" id="sell-${bIndex}-${iIndex}" min="1" max="${item.stock}"></td>
        <td>
        <button onclick="sell(${bIndex}, ${iIndex})">B√°n</button>
        <button onclick="deleteItem(${bIndex}, ${iIndex})">üóë</button>
        <button onclick="moveItem(${bIndex}, ${iIndex}, -1)">‚¨ÜÔ∏è</button>
        <button onclick="moveItem(${bIndex}, ${iIndex}, 1)">‚¨áÔ∏è</button>
        </td>
      </tr>`;
    });
    html += `</table>`;

    html += `
      <div class="form-group">
        <h4>‚ûï Th√™m m√≥n</h4>
        <input placeholder="T√™n m√≥n" id="new-name-${bIndex}">
        <input placeholder="ƒê∆°n v·ªã" id="new-unit-${bIndex}">
        <input placeholder="T·ªìn kho" type="number" id="new-stock-${bIndex}">
        <input placeholder="Gi√°" type="number" id="new-price-${bIndex}">
        <button onclick="addItem(${bIndex})">Th√™m</button>
      </div>
    `;

    container.appendChild(div);
    div.innerHTML = html;
  });
}

function renderReport() {
  const report = document.getElementById('report');
  const grouped = {};
  salesData.logs.forEach(log => {
    const date = log.time.slice(0, 10);
    const month = log.time.slice(0, 7);
    if (!grouped[month]) grouped[month] = {};
    if (!grouped[month][date]) grouped[month][date] = [];
    grouped[month][date].push(log);
  });

  let html = '';
  const months = Object.keys(grouped).sort((a, b) => b.localeCompare(a));
  if (months.length === 0) {
    report.innerText = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.';
    return;
  }

  months.forEach((month, index) => {
    const monthId = `month-${index}`;
    let monthTotal = 0;
    let monthTable = '';

    const days = Object.keys(grouped[month]).sort((a, b) => b.localeCompare(a));
    days.forEach(date => {
      let dayTotal = 0;
      let dayRows = '';

      grouped[month][date].forEach(log => {
        const amount = log.price * log.quantity;
        dayTotal += amount;
        monthTotal += amount;
        dayRows += `
          <tr>
            <td data-label="Ng√†y">${date}</td>
            <td data-label="Chi nh√°nh">${log.branch}</td>
            <td data-label="M√≥n">${log.item}</td>
            <td class="numeric" data-label="S·ªë l∆∞·ª£ng">${log.quantity} ${log.unit || ''}</td>
            <td class="numeric" data-label="Gi√°">${log.price.toLocaleString()}‚Ç´</td>
            <td class="numeric" data-label="Th√†nh ti·ªÅn">${amount.toLocaleString()}‚Ç´</td>
          </tr>
        `;
      });
      dayRows += `
          <tr style="background: #f1f1f1; font-weight: bold;">
            <td colspan="5" style="text-align:right;">T·ªïng ng√†y ${date}:</td>
            <td class="numeric">${dayTotal.toLocaleString()}‚Ç´</td>
          </tr>
        `;
      monthTable += dayRows;
    });

    html += `
      <div class="month-section">
        <div class="month-header" onclick="toggleMonth('${monthId}')">üóì Th√°ng ${month} ‚Äî T·ªïng: ${monthTotal.toLocaleString()}‚Ç´</div>
        <div id="${monthId}" class="month-content">
          <table>
            <thead>
              <tr>
                <th>Ng√†y</th><th>Chi nh√°nh</th><th>M√≥n</th><th>S·ªë l∆∞·ª£ng</th><th>Gi√°</th><th>Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>
              ${monthTable}
            </tbody>
          </table>
        </div>
      </div>
    `;
  });

  report.innerHTML = html;
}

function toggleMonth(id) {
  const el = document.getElementById(id);
  el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
}

function addBranch() {
  const name = document.getElementById('newBranchName').value.trim();
  if (!name) return alert('Nh·∫≠p t√™n chi nh√°nh!');
  const pin = prompt("Nh·∫≠p m√£ PIN cho chi nh√°nh:");
  salesData.branches.push({ name, pin, menu: [] });
  saveData();
}

function addItem(bIndex) {
  const name = document.getElementById(`new-name-${bIndex}`).value.trim();
  const unit = document.getElementById(`new-unit-${bIndex}`).value.trim();
  const stock = parseInt(document.getElementById(`new-stock-${bIndex}`).value);
  const price = parseInt(document.getElementById(`new-price-${bIndex}`).value);
  if (!name || !unit || isNaN(stock) || isNaN(price)) return alert('Nh·∫≠p ƒë·ªß th√¥ng tin m√≥n!');
  salesData.branches[bIndex].menu.push({ name, unit, stock, price });
  saveData();
}
function moveItem(bIndex, iIndex, direction) {
  const menu = salesData.branches[bIndex].menu;
  const newIndex = iIndex + direction;

  // Ki·ªÉm tra gi·ªõi h·∫°n
  if (newIndex < 0 || newIndex >= menu.length) return;

  // ƒê·ªïi v·ªã tr√≠
  const temp = menu[iIndex];
  menu[iIndex] = menu[newIndex];
  menu[newIndex] = temp;

  saveData(false); 
  renderBranches(); 
}


function editItem(bIndex, iIndex, field, value) {
  if (field === 'stock' || field === 'price') value = parseInt(value);
  salesData.branches[bIndex].menu[iIndex][field] = value;
  saveData(false);
}

function deleteItem(bIndex, iIndex) {
  if (!confirm('X√≥a m√≥n n√†y?')) return;
  salesData.branches[bIndex].menu.splice(iIndex, 1);
  saveData();
}

function sell(bIndex, iIndex) {
  const input = document.getElementById(`sell-${bIndex}-${iIndex}`);
  const qty = parseInt(input.value);
  const item = salesData.branches[bIndex].menu[iIndex];
  if (!qty || qty <= 0 || qty > item.stock) return alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.');

  item.stock -= qty;
  salesData.logs.push({
    branch: salesData.branches[bIndex].name,
    item: item.name,
    unit: item.unit || '',
    quantity: qty,
    price: item.price,
    time: new Date().toISOString()
  });

  sendTelegram(`ƒê√£ b√°n ${qty} ${item.unit || ''} ${item.name} t·∫°i ${salesData.branches[bIndex].name}`);
  saveData();
}

async function sendTelegram(msg) {
  await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
  });
}

function editPin(bIndex, newPin) {
  const branchName = salesData.branches[bIndex].name;
  salesData.branches[bIndex].pin = newPin;
  for (const pin in salesData.pins) {
    if (salesData.pins[pin] === branchName) delete salesData.pins[pin];
  }
  salesData.pins[newPin] = branchName;
  saveData(false);
}

function togglePin(bIndex) {
  const input = document.getElementById(`pin-${bIndex}`);
  input.type = input.type === 'password' ? 'text' : 'password';
}

async function saveData(refresh = true) {
  await fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify(salesData),
  });
  if (refresh) fetchSalesData();
}

fetchSalesData();
</script>
</body>
</html>
