<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B√°n h√†ng Nh·ª•y Nguy√™n</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f8f9fa;
      color: #333;
    }
    header {
      background: #00a86b;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.2rem;
    }
    .container {
      padding: 1rem;
    }
    .hidden {
      display: none;
    }
    input, select, button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    button {
      background-color: #00a86b;
      color: white;
      font-weight: bold;
      border: none;
    }
    button:hover {
      background-color: #007f50;
    }
    .menu-item {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: white;
    }
    .menu-item h3 {
      margin: 0 0 0.5rem 0;
    }
    .menu-item input {
      width: 80px;
      display: inline-block;
      margin-left: 1rem;
    }
    .status {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>H·ªá th·ªëng b√°n h√†ng - Nh·ª•y Nguy√™n</header>

  <div id="pinScreen" class="container">
    <h2>üîí Nh·∫≠p m√£ PIN chi nh√°nh</h2>
    <input type="password" id="pinInput" placeholder="Nh·∫≠p m√£ PIN" />
    <button onclick="checkPin()">Ti·∫øp t·ª•c</button>
    <div id="pinMessage" class="status"></div>
  </div>

  <div id="salesScreen" class="container hidden">
    <h2 id="branchName"></h2>
    <div id="menuList"></div>
    <button onclick="submitSales()">G·ª≠i ƒë∆°n b√°n h√†ng</button>
    <div id="submitMessage" class="status"></div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbd5QQ5B8KThT2Zbl3h_2vHRbLk2T45_Wc2Kbr6AtbRedfxKxravAC6bPfPAilg8WbFQ/exec'; // Thay b·∫±ng URL th·∫≠t c·ªßa b·∫°n
    let salesData = {};
    let currentBranchIndex = -1;

    async function checkPin() {
      const pin = document.getElementById('pinInput').value.trim();
      const msg = document.getElementById('pinMessage');
      msg.textContent = '';

      if (!pin) {
        msg.textContent = 'Vui l√≤ng nh·∫≠p m√£ PIN.';
        msg.style.color = 'red';
        return;
      }

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          mode:'no-cors',
          body: JSON.stringify({ action: 'checkPin', pin })
        });
        const result = await res.json();

        if (!result.success) {
          msg.textContent = result.message || 'M√£ PIN kh√¥ng ƒë√∫ng.';
          msg.style.color = 'red';
          return;
        }

        await fetchSalesData();
        currentBranchIndex = salesData.branches.findIndex(b => b.name === result.branch);
        if (currentBranchIndex === -1) {
          msg.textContent = 'Chi nh√°nh kh√¥ng t·ªìn t·∫°i.';
          msg.style.color = 'red';
          return;
        }

        document.getElementById('pinScreen').classList.add('hidden');
        document.getElementById('salesScreen').classList.remove('hidden');
        document.getElementById('branchName').textContent = result.branch;
        renderMenu();

      } catch (err) {
        msg.textContent = 'L·ªói k·∫øt n·ªëi ƒë·∫øn server.';
        msg.style.color = 'red';
      }
    }

    async function fetchSalesData() {
      const res = await fetch(SCRIPT_URL);
      salesData = await res.json();
    }

    function renderMenu() {
      const menuList = document.getElementById('menuList');
      menuList.innerHTML = '';
      const menu = salesData.branches[currentBranchIndex].menu;
      menu.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.innerHTML = `
          <h3>${item.name} - ${item.price.toLocaleString()}ƒë</h3>
          <label>S·ªë l∆∞·ª£ng:</label>
          <input type="number" min="0" value="0" id="qty-${index}" />
        `;
        menuList.appendChild(div);
      });
    }

    async function submitSales() {
      const now = new Date();
      const branch = salesData.branches[currentBranchIndex];
      const soldItems = [];

      branch.menu.forEach((item, index) => {
        const qty = parseInt(document.getElementById(`qty-${index}`).value);
        if (qty > 0) {
          soldItems.push({ name: item.name, qty, price: item.price });
          item.stock -= qty; // C·∫≠p nh·∫≠t t·ªìn kho
        }
      });

      if (soldItems.length === 0) {
        document.getElementById('submitMessage').textContent = 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√≥n.';
        document.getElementById('submitMessage').style.color = 'red';
        return;
      }

      salesData.logs.push({
        branch: branch.name,
        date: now.toISOString(),
        items: soldItems
      });

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(salesData)
        });
        if (res.ok) {
          document.getElementById('submitMessage').textContent = '‚úÖ ƒê√£ ghi nh·∫≠n ƒë∆°n h√†ng!';
          document.getElementById('submitMessage').style.color = 'green';
          renderMenu(); // L√†m m·ªõi s·ªë l∆∞·ª£ng
        } else {
          throw new Error();
        }
      } catch (err) {
        document.getElementById('submitMessage').textContent = '‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu.';
        document.getElementById('submitMessage').style.color = 'red';
      }
    }
  </script>
</body>
</html>
