<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>💬 Chat Nhân Viên</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0; font-family: 'Segoe UI', sans-serif; background: #f2f5f8; display: flex; flex-direction: column; height: 100vh;
    }
    header {
      background: #3f51b5; color: white; padding: 12px 20px; font-size: 20px;
    }
    #chat-box {
      flex: 1; overflow-y: auto; padding: 20px;
    }
    .message {
      margin: 10px 0; padding: 10px 14px; border-radius: 12px; max-width: 70%; line-height: 1.4;
      background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .me {
      background: #e3f2fd; align-self: flex-end; text-align: right;
    }
    .meta {
      font-size: 12px; color: #888; margin-top: 4px;
    }
    #chat-input {
      display: flex; border-top: 1px solid #ccc; padding: 10px; background: #fff;
    }
    #chat-input input {
      flex: 1; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px;
    }
    #chat-input button {
      margin-left: 10px; padding: 10px 16px; font-size: 16px; background: #3f51b5; color: white;
      border: none; border-radius: 8px; cursor: pointer;
    }
  </style>
  <script src="../auth.js"></script>
</head>
<body>
  <header>💬 Chat Nhân Viên</header>
  <div id="chat-box"></div>
  <div id="chat-input">
    <input type="text" id="message-input" placeholder="Nhập tin nhắn..." />
    <button onclick="toggleEmoji()">😊</button>
    <button onclick="sendMessage()">Gửi</button>

  </div>
<div id="emoji-box" style="display:none;position:absolute;bottom:60px;right:20px;
  background:#fff;padding:10px;border:1px solid #ccc;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">
  😀 😁 😂 🤣 😍 😎 😢 😡 👍 👎 ❤️ 🙌 🎉 🐱‍👤
</div>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwe4DkIb0GliPuL32aHWXiW_E9mvbmDubjIXBGAretzmh3QZookm55gB1Qfgw3c-ZJC/exec';
    let auth = JSON.parse(localStorage.getItem('auth') || '{}');
    const user = auth?.id;
    if (!user) {
      alert("Bạn chưa đăng nhập. Vui lòng đăng nhập lại.");
      location.reload();
    }

    let lastVersion = 0;
    let chatData = [];

    const chatBox = document.getElementById('chat-box');

    function formatTime(iso) {
      const date = new Date(iso);
      return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
    }

    function toggleEmoji() {
            const box = document.getElementById('emoji-box');
            box.style.display = box.style.display === 'none' ? 'block' : 'none';
            }
            document.getElementById('emoji-box')?.addEventListener('click', (e) => {
            if (e.target.textContent.trim()) {
                const input = document.getElementById('message-input');
                input.value += e.target.textContent.trim();
                input.focus();
            }
            });

    function renderChat() {
      chatBox.innerHTML = '';
      chatData.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message' + (msg.user === user ? ' me' : '');
        div.innerHTML = `
          <div><strong>${msg.user}</strong>: ${msg.text}</div>
          <div class="meta">${formatTime(msg.time)}</div>
        `;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function fetchMessages() {
      const res = await fetch(`${GAS_URL}?action=get_messages`);
      const data = await res.json();
      chatData = data.messages || [];
      renderChat();
    }

    async function checkForUpdates() {
      try {
        const res = await fetch(`${GAS_URL}?action=get_version`);
        const { version } = await res.json();
        if (version > lastVersion) {
          lastVersion = version;
          fetchMessages();
        }
      } catch (e) {
        console.error("Lỗi khi kiểm tra version:", e);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text) return;

      await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'send',
          user: user,
          text: text,
          time: new Date().toISOString()
        }),
      });

      input.value = '';
      checkForUpdates();
    }

    fetchMessages();
    setInterval(checkForUpdates, 3000);
  </script>
</body>
</html>
