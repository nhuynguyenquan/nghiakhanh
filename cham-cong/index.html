<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ch·∫•m c√¥ng nh√¢n vi√™n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f0f0;
      padding: 1.5rem;
      text-align: center;
    }
    h2 {
      margin-bottom: 1rem;
    }
    select, button {
      font-size: 1.2rem;
      padding: 0.75rem;
      margin: 0.5rem auto;
      width: 90%;
      max-width: 400px;
      display: block;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    #checkOutBtn {
      background-color: #f44336;
    }
    #status {
      margin-top: 1.5rem;
      font-size: 1.1rem;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <h2>üïí Ch·∫•m c√¥ng nh√¢n vi√™n</h2>
  <select id="employeeSelect" onchange="updateButtons()"></select>
  <button id="checkInBtn" onclick="checkIn()">‚úÖ V√†o ca</button>
  <button id="checkOutBtn" onclick="checkOut()">‚õî Ra ca</button>
  <div id="status">ƒêang t·∫£i d·ªØ li·ªáu...</div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxfSnimiGKE1uDDKdtnU1v5gUBEu7p0B4xQ5mfMFVZWDVa_7xiG_WzqVzOTP7ARdgLMmw/exec';
    const TELEGRAM_TOKEN = '7783089403:AAGNpG6GsdlF7VXVfPTW8Y1xQJEqBahL1PY';
    const CHAT_ID = '6249154937';

    let data = { employees: [], attendance: [] };

    async function loadData() {
      try {
        const res = await fetch(API_URL);
        data = await res.json();
        if (!Array.isArray(data.attendance)) data.attendance = [];
        if (!Array.isArray(data.employees)) data.employees = [];

        const select = document.getElementById("employeeSelect");
        select.innerHTML = data.employees.map(e =>
          `<option value="${e.id}">${e.name}</option>`
        ).join("");

        updateButtons();
      } catch (error) {
        document.getElementById("status").textContent = "L·ªói t·∫£i d·ªØ li·ªáu.";
      }
    }

    function roundUp15(date) {
      const ms = 15 * 60 * 1000;
      return new Date(Math.ceil(date.getTime() / ms) * ms);
    }

    function roundDown15(date) {
      const ms = 15 * 60 * 1000;
      return new Date(Math.floor(date.getTime() / ms) * ms);
    }

    function getShiftTimeRange() {
      const now = new Date();
      const vnOffset = 7 * 60 * 60 * 1000;
      const vnNow = new Date(now.getTime() + vnOffset);

      const today17hUTC = new Date(Date.UTC(vnNow.getUTCFullYear(), vnNow.getUTCMonth(), vnNow.getUTCDate(), 10)); // 17h VN = 10h UTC
      const yesterday17hUTC = new Date(today17hUTC.getTime() - 24 * 60 * 60 * 1000);

      return {
        start: yesterday17hUTC.toISOString(),
        end: today17hUTC.toISOString()
      };
    }

    function updateButtons() {
      const id = document.getElementById("employeeSelect").value;
      const { start, end } = getShiftTimeRange();

      const logs = data.attendance.filter(a =>
        a.employeeId === id && a.checkIn >= start && a.checkIn < end
      );

      const entry = logs[logs.length - 1];
      const checkInBtn = document.getElementById("checkInBtn");
      const checkOutBtn = document.getElementById("checkOutBtn");
      const status = document.getElementById("status");

      if (!entry) {
        checkInBtn.disabled = false;
        checkOutBtn.disabled = true;
        status.textContent = "üü° Ch∆∞a v√†o ca";
      } else if (!entry.checkOut) {
        checkInBtn.disabled = true;
        checkOutBtn.disabled = false;
        status.textContent = "üü¢ ƒê√£ v√†o ca l√∫c " + formatTime(entry.checkIn);
      } else {
        checkInBtn.disabled = true;
        checkOutBtn.disabled = true;
        status.textContent = "üî¥ ƒê√£ ra ca l√∫c " + formatTime(entry.checkOut);
      }
    }

    async function checkIn() {
      const id = document.getElementById("employeeSelect").value;
      const now = roundUp15(new Date()).toISOString();
      const { start, end } = getShiftTimeRange();

      const alreadyIn = data.attendance.some(a =>
        a.employeeId === id && a.checkIn >= start && a.checkIn < end && !a.checkOut
      );

      if (alreadyIn) {
        alert("‚õî B·∫°n ƒë√£ v√†o ca trong ca hi·ªán t·∫°i.");
        return;
      }

      data.attendance.push({ employeeId: id, checkIn: now, checkOut: "" });
      await saveData();
      alert("‚úÖ V√†o ca th√†nh c√¥ng.");
      sendTelegram(`üü¢ ${getName(id)} ƒë√£ v√†o ca l√∫c ${formatTime(now)}`);
      updateButtons();
    }

    async function checkOut() {
      const id = document.getElementById("employeeSelect").value;
      const now = roundDown15(new Date()).toISOString();
      const { start, end } = getShiftTimeRange();

      const entry = data.attendance.find(a =>
        a.employeeId === id && a.checkIn >= start && a.checkIn < end && !a.checkOut
      );

      if (!entry) {
        alert("Kh√¥ng t√¨m th·∫•y ca l√†m trong ca hi·ªán t·∫°i.");
        return;
      }

      entry.checkOut = now;
      await saveData();
      alert("‚õî Ra ca th√†nh c√¥ng.");
      sendTelegram(`üî¥ ${getName(id)} ƒë√£ ra ca l√∫c ${formatTime(now)}`);
      updateButtons();
    }

    async function saveData() {
      try {
        await fetch(API_URL, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });
      } catch (error) {
        console.error("L·ªói khi l∆∞u d·ªØ li·ªáu:", error);
      }
    }

    function sendTelegram(message) {
      const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(message)}`;
      fetch(url);
    }

    function getName(id) {
      const emp = data.employees.find(e => e.id === id);
      return emp ? emp.name : "Kh√¥ng r√µ";
    }

    function formatTime(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString("vi-VN", { hour: '2-digit', minute: '2-digit' });
    }

    loadData();
  </script>
</body>
</html>
