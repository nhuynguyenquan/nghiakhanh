<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chấm công nhân viên</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 1rem; }
    select, button { font-size: 1.2rem; margin: 10px; padding: 10px; width: 80%; }
    #status { font-size: 1.1rem; margin-top: 1rem; color: #333; }
  </style>
</head>
<body>
  <h2>🕒 Chấm công</h2>
  <select id="employeeSelect" onchange="updateButtons()"></select><br>
  <button id="checkInBtn" onclick="checkIn()">✅ Vào ca</button>
  <button id="checkOutBtn" onclick="checkOut()">⛔ Ra ca</button>
  <div id="status">🔄 Đang tải...</div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxfSnimiGKE1uDDKdtnU1v5gUBEu7p0B4xQ5mfMFVZWDVa_7xiG_WzqVzOTP7ARdgLMmw/exec'; 
    const TELEGRAM_TOKEN = '7783089403:AAGNpG6GsdlF7VXVfPTW8Y1xQJEqBahL1PY';
    const CHAT_ID = '6249154937';

    let data = {};

    async function loadData() {
      const res = await fetch(API_URL);
      data = await res.json();
      if (!Array.isArray(data.attendance)) data.attendance = [];

      const sel = document.getElementById("employeeSelect");
      sel.innerHTML = data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join("");
      updateButtons();
    }

    function roundDown15(d) {
      const ms = 15 * 60 * 1000;
      return new Date(Math.floor(d.getTime() / ms) * ms);
    }

    function roundUp15(d) {
      const ms = 15 * 60 * 1000;
      return new Date(Math.ceil(d.getTime() / ms) * ms);
    }

    async function checkIn() {
      const id = document.getElementById("employeeSelect").value;
      const now = roundUp15(new Date()).toISOString();
      const today = now.slice(0, 10);

      const hasOpenEntry = data.attendance.some(a =>
        a.employeeId === id &&
        a.checkIn.startsWith(today) &&
        !a.checkOut
      );

      if (hasOpenEntry) {
        alert("⛔ Bạn chưa ra ca trước.");
        return;
      }

      data.attendance.push({ employeeId: id, checkIn: now, checkOut: "" });
      await saveData();
      alert("✅ Đã vào ca");
      sendTelegram(`🟢 ${getName(id)} đã vào ca lúc ${formatTime(now)}`);
      updateButtons();
    }

    async function checkOut() {
      const id = document.getElementById("employeeSelect").value;
      const now = roundDown15(new Date()).toISOString();
      const today = now.slice(0, 10);

      const logs = data.attendance
        .filter(a => a.employeeId === id && a.checkIn.startsWith(today))
        .sort((a, b) => new Date(b.checkIn) - new Date(a.checkIn));

      const openEntry = logs.reverse().find(a => !a.checkOut);
      if (!openEntry) {
        alert("Không tìm thấy ca đang làm hôm nay.");
        return;
      }

      openEntry.checkOut = now;
      await saveData();
      alert("⛔ Đã ra ca");
      sendTelegram(`🔴 ${getName(id)} đã ra ca lúc ${formatTime(now)}`);
      updateButtons();
    }

    async function saveData() {
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      });
    }

    function sendTelegram(msg) {
      const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(msg)}`;
      fetch(url);
    }

    function getName(id) {
      const emp = data.employees.find(e => e.id === id);
      return emp ? emp.name : "Không rõ";
    }

    function formatTime(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString("vi-VN", { hour: '2-digit', minute: '2-digit' });
    }

    function updateButtons() {
      const id = document.getElementById("employeeSelect").value;
      const today = new Date().toISOString().slice(0, 10);

      const logs = data.attendance
        .filter(a => a.employeeId === id && a.checkIn.startsWith(today))
        .sort((a, b) => new Date(b.checkIn) - new Date(a.checkIn));

      const latest = logs[logs.length - 1];

      const checkInBtn = document.getElementById("checkInBtn");
      const checkOutBtn = document.getElementById("checkOutBtn");
      const status = document.getElementById("status");

      if (!latest) {
        checkInBtn.disabled = false;
        checkOutBtn.disabled = true;
        status.textContent = "🟡 Chưa vào ca";
      } else if (!latest.checkOut) {
        checkInBtn.disabled = true;
        checkOutBtn.disabled = false;
        status.textContent = "🟢 Đã vào ca lúc " + formatTime(latest.checkIn);
      } else {
        checkInBtn.disabled = false;
        checkOutBtn.disabled = true;
        status.textContent = "🔴 Đã ra ca lúc " + formatTime(latest.checkOut);
      }
    }

    loadData();
  </script>
</body>
</html>
