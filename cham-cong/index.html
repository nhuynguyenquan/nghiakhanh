<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ch·∫•m c√¥ng nh√¢n vi√™n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 1rem; }
    select, button { font-size: 1.2rem; margin: 10px; padding: 10px; width: 80%; }
    #status { font-size: 1.1rem; margin-top: 1rem; color: #333; }
  </style>
</head>
<body>
  <h2>üïí Ch·∫•m c√¥ng</h2>
  <select id="employeeSelect" onchange="updateButtons()"></select><br>
  <button id="checkInBtn" onclick="checkIn()">‚úÖ V√†o ca</button>
  <button id="checkOutBtn" onclick="checkOut()">‚õî Ra ca</button>
  <div id="status">üîÑ ƒêang t·∫£i...</div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxfSnimiGKE1uDDKdtnU1v5gUBEu7p0B4xQ5mfMFVZWDVa_7xiG_WzqVzOTP7ARdgLMmw/exec'; 
    let data = {};
async function loadData() {
  try {
    const res = await fetch(API_URL);
    data = await res.json();

    if (!Array.isArray(data.employees)) data.employees = [];
    if (!Array.isArray(data.attendance)) data.attendance = [];

    renderEmployees();
    renderSelect();
    calculateAttendance();
  } catch(e) {
    alert("L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.");
    console.error(e);
  }
}

function renderEmployees() {
  const table = document.getElementById("employeeTable");
  let html = `<tr><th>T√™n</th><th>Ch·ª©c v·ª•</th><th>L∆∞∆°ng/ng√†y</th><th>Ghi ch√∫</th></tr>`;
  for (const emp of data.employees) {
    html += `<tr>
      <td>${emp.name}</td>
      <td>${emp.role}</td>
      <td>${emp.salaryPerDay.toLocaleString('vi-VN')} ƒë</td>
      <td>${emp.note}</td>
    </tr>`;
  }
  table.innerHTML = html;
}

function renderSelect() {
  const sel = document.getElementById("employeeSelect");
  sel.innerHTML = data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join("");
}

function genId() {
  return 'nv' + Date.now();
}

async function addEmployee() {
  const name = document.getElementById("name").value.trim();
  const role = document.getElementById("role").value.trim();
  const salary = parseInt(document.getElementById("salary").value);
  const note = document.getElementById("note").value.trim();

  if (!name || isNaN(salary)) {
    return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n v√† l∆∞∆°ng.");
  }

  const newEmp = {
    id: genId(),
    name,
    role,
    salaryPerDay: salary,
    note
  };

  data.employees.push(newEmp);
  await saveData();
  alert("ƒê√£ th√™m nh√¢n vi√™n.");

  document.getElementById("name").value = "";
  document.getElementById("role").value = "";
  document.getElementById("salary").value = "";
  document.getElementById("note").value = "";

  loadData();
}

async function checkIn() {
  const id = document.getElementById("employeeSelect").value;
  const now = new Date().toISOString();

  if (!Array.isArray(data.attendance)) data.attendance = [];

  data.attendance.push({ employeeId: id, checkIn: now, checkOut: "" });
  await saveData();
  const emp = data.employees.find(e => e.id === id);
  const name = emp ? emp.name : 'Kh√¥ng r√µ';
  sendTelegramMessage(`‚úÖ Nh√¢n vi√™n <b>${name}</b> ƒë√£ v√†o ca l√∫c ${new Date().toLocaleTimeString("vi-VN")}`);
  alert("‚úÖ ƒê√£ ch·∫•m v√†o ca.");
  loadData();
}

async function checkOut() {
  const id = document.getElementById("employeeSelect").value;
  const now = new Date().toISOString();

  const vnNow = new Date(new Date().getTime() + 7 * 60 * 60 * 1000);
  const todayVN = vnNow.toISOString().slice(0, 10);

  const entry = data.attendance.find(a => {
    if (a.employeeId !== id || a.checkOut) return false;
    const checkInDate = new Date(a.checkIn);
    const checkInVN = new Date(checkInDate.getTime() + 7 * 60 * 60 * 1000);
    const checkInDateStr = checkInVN.toISOString().slice(0, 10);
    return checkInDateStr === todayVN;
  });

  if (!entry) return alert("Kh√¥ng t√¨m th·∫•y ca l√†m ƒë·ªÉ ra ca.");

  entry.checkOut = now;
  await saveData();
  const emp = data.employees.find(e => e.id === id);
  const name = emp ? emp.name : 'Kh√¥ng r√µ';
  sendTelegramMessage(`‚õî Nh√¢n vi√™n <b>${name}</b> ƒë√£ ra ca l√∫c ${new Date().toLocaleTimeString("vi-VN")}`);
  alert("‚õî ƒê√£ ch·∫•m ra ca.");
  loadData();
}

async function saveData() {
  await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(data),
    mode: "no-cors",
    headers: { 'Content-Type': 'application/json' }
  });
}

function calculateAttendance() {
  const selectedMonth = document.getElementById("monthPicker").value;
  const selectedDate = document.getElementById("datePicker").value;

  const summary = {};
  for (const emp of data.employees) {
    summary[emp.id] = {
      name: emp.name,
      totalHours: 0,
      sessions: 0
    };
  }

  for (const log of data.attendance) {
    if (!log.checkIn || !log.checkOut || log.checkOut.trim() === "") continue;

    let checkInDate = new Date(log.checkIn);
    let checkOutDate = new Date(log.checkOut);

    if (isNaN(checkInDate) || isNaN(checkOutDate)) continue;

    checkInDate = new Date(checkInDate.getTime() + 7 * 60 * 60 * 1000);
    checkOutDate = new Date(checkOutDate.getTime() + 7 * 60 * 60 * 1000);

    const logDateStr = checkInDate.toISOString().slice(0, 10);
    const logMonthStr = checkInDate.toISOString().slice(0, 7);

    if (selectedDate && logDateStr !== selectedDate) continue;
    if (selectedMonth && logMonthStr !== selectedMonth) continue;

    const diffMs = checkOutDate - checkInDate;
    if (diffMs <= 0) continue;

    const hours = diffMs / 3600000;

    const emp = summary[log.employeeId];
    if (emp) {
      emp.totalHours += hours;
      emp.sessions += 1;
    }
  }

  for (const emp of Object.values(summary)) {
    emp.totalHours = isNaN(emp.totalHours) ? 0 : emp.totalHours;
    emp.totalHours = emp.totalHours.toFixed(2);
    const days = emp.totalHours / 8; // 8 gi·ªù = 1 c√¥ng
    emp.totalDays = isNaN(days) ? "0.0" : days.toFixed(1);
  }

  const table = document.getElementById("summaryTable");
  let html = `<tr>
    <th>Nh√¢n vi√™n</th>
    <th>S·ªë ca</th>
    <th>S·ªë gi·ªù</th>
    <th>Ng√†y c√¥ng (∆∞·ªõc t√≠nh)</th>
  </tr>`;

  for (const emp of Object.values(summary)) {
    if (emp.sessions > 0) {
      html += `<tr>
        <td>${emp.name}</td>
        <td>${emp.sessions}</td>
        <td>${emp.totalHours}</td>
        <td>${emp.totalDays}</td>
      </tr>`;
    }
  }

  table.innerHTML = html;
}

// Load d·ªØ li·ªáu khi trang m·ªü
loadData();

const TELEGRAM_BOT_TOKEN = '7783089403:AAGNpG6GsdlF7VXVfPTW8Y1xQJEqBahL1PY'; 
const TELEGRAM_CHAT_ID = '6249154937';    

function sendTelegramMessage(message) {
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  const payload = {
    chat_id: TELEGRAM_CHAT_ID,
    text: message,
    parse_mode: 'HTML'
  };

  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(err => console.error("Telegram Error:", err));
}
</script>
</body>
</html>
