<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cháº¥m cÃ´ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:sans-serif;text-align:center;padding:1rem}
    select,button,input{font-size:1.2rem;margin:10px;padding:10px;width:80%}
    #status{margin-top:1rem;font-weight:bold;color:green}
    #app{display:none}
  </style>
</head>
<body>
<div id="loadingOverlay" style="
  display:none;
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(255,255,255,0.8);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.5rem;
  font-weight:bold;
  color:#333;">
  â³ Äang xá»­ lÃ½...
</div>
<!-- Khung Ä‘Äƒng nháº­p PIN -->
<div id="loginBox">
  <h2>ğŸ” Nháº­p mÃ£ PIN</h2>
  <input id="pinInput" type="password" placeholder="MÃ£ PIN...">
  <button onclick="checkPin()">ğŸ”“ VÃ o há»‡ thá»‘ng</button>
  <div id="loginMsg" style="color:red;font-weight:bold;"></div>
</div>

<!-- Giao diá»‡n cháº¥m cÃ´ng -->
<div id="app">
  <h2>ğŸ•’ Cháº¥m cÃ´ng</h2>
  <select id="employeeSelect" onchange="updateButtons()"></select><br>
  <button id="checkInBtn"  onclick="checkIn()">âœ… VÃ o ca</button>
  <button id="checkOutBtn" onclick="checkOut()">â›” Ra ca</button>
  <div id="status"></div>
</div>

<script>
/* ---------- Cáº¤U HÃŒNH ---------- */
const API_URL = 'https://script.google.com/macros/s/AKfycbygLiXyIXgDVfWdbOsH24bYSrSrI8ezFKyHw1xYtBdhl81C2DPGMaSB2N41bcipgn5juA/exec';
const PIN_URL = 'https://script.google.com/macros/s/AKfycbzOry6wmWk8JPYtZuF_ThdfqzJGlpjVek1G2r3gb-fpKFScLeB3iPYj7Dk3I3VvDTIUeA/exec';

let data = {}, pinList = [];

/* ---------- SHAâ€‘256 ---------- */
async function sha256(str){
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest("SHA-256", buf);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ---------- KIá»‚M TRA PIN ---------- */
async function checkPin(){
  const input = document.getElementById("pinInput").value.trim();
  if (!input) return;

  showLoading("ğŸ” Äang kiá»ƒm tra mÃ£ PIN...");
  if (pinList.length === 0) await loadPinList();

  const hashed = await sha256(input);
  if (!pinList.includes(hashed)) {
    hideLoading();
    document.getElementById("loginMsg").textContent = "âŒ MÃ£ PIN khÃ´ng há»£p lá»‡.";
    return;
  }

  savePinSession(hashed);
  await openApp();  // sáº½ gá»i hideLoading() trong openApp
}

/* ---------- LÆ¯U & KHÃ”I PHá»¤C PIN TRONG SESSION ---------- */
function todayStr(){ return new Date().toISOString().slice(0,10); } // yyyy-mm-dd

function savePinSession(hash){
  sessionStorage.setItem("pinData", JSON.stringify({hash, date: todayStr()}));
}

function getPinSession(){
  try{ return JSON.parse(sessionStorage.getItem("pinData")||"{}"); }
  catch{ return {}; }
}

function clearPinSession(){
  sessionStorage.removeItem("pinData");
}

/* ---------- Táº¢I PIN LIST SHAâ€‘256 ---------- */
async function loadPinList() {
  try {
    const res = await fetch(PIN_URL);
    const json = await res.json();
    pinList = json.pins || [];
  } catch (err) {
    hideLoading();
    document.getElementById("loginMsg").textContent = "âš ï¸ Lá»—i táº£i PIN. Vui lÃ²ng thá»­ láº¡i.";
  }
}

/* ---------- KHá»I Äá»˜NG ---------- */
(async function bootstrap(){
  await loadPinList();                       // táº£i sáºµn danh sÃ¡ch PIN
  const saved = getPinSession();
  if(saved.hash && saved.date === todayStr() && pinList.includes(saved.hash)){
    openApp();                               // valid -> bá» qua Ä‘Äƒng nháº­p
  } else {
    clearPinSession();                       // háº¿t háº¡n / khÃ´ng há»£p lá»‡
  }
  // Timer: má»—i 60s kiá»ƒm tra sang ngÃ y má»›i
  setInterval(()=>{ if(getPinSession().date !== todayStr()){ location.reload(); } }, 60000);
})();

/* ---------- Má» GIAO DIá»†N CHáº¤M CÃ”NG ---------- */
async function openApp(){
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("app").style.display = "block";
  await loadData();
  hideLoading(); // thÃªm á»Ÿ Ä‘Ã¢y
}

/* ---------- LOAD DATA (KHÃ”NG Äá»”I) ---------- */
async function loadData(){
  const res = await fetch(API_URL);
  data = await res.json();
  if(!Array.isArray(data.employees))  data.employees  = [];
  if(!Array.isArray(data.attendance)) data.attendance = [];

  const sel = document.getElementById("employeeSelect");
  sel.innerHTML = data.employees.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  updateButtons();
}

/* ---------- CÃC HÃ€M CHáº¤M CÃ”NG GIá»® NGUYÃŠN ---------- */
function formatTime(i){ return new Date(i).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); }
function roundUp15(d){const m=d.getMinutes(),adj=m%15?15-m%15:0;d.setMinutes(m+adj,0,0);return d;}
function roundDown15(d){d.setMinutes(d.getMinutes()-d.getMinutes()%15,0,0);return d;}
function getShiftTimeRange(){
  const n=new Date(),s=new Date(n);s.setHours(0,0,0,0);const e=new Date(n);e.setHours(23,59,59,999);
  return { start:s.toISOString(), end:e.toISOString() };
}

function updateButtons(){
  const id=document.getElementById("employeeSelect").value;
  const {start,end} = getShiftTimeRange();
  const logs=data.attendance.filter(a=>a.employeeId===id&&a.checkIn>=start&&a.checkIn<=end)
                            .sort((a,b)=>new Date(b.checkIn)-new Date(a.checkIn));
  const entry=logs.find(a=>!a.checkOut);
  document.getElementById("checkInBtn").disabled = !!entry;
  document.getElementById("checkOutBtn").disabled= !entry;
  document.getElementById("status").textContent = entry
        ? entry.checkOut ? `ğŸ”´ ÄÃ£ ra ca lÃºc ${formatTime(entry.checkOut)}`
                         : `ğŸŸ¢ Äang lÃ m ca báº¯t Ä‘áº§u lÃºc ${formatTime(entry.checkIn)}`
        : "ğŸŸ¡ Sáºµn sÃ ng vÃ o ca má»›i";
}

async function checkIn(){
  const id = document.getElementById("employeeSelect").value;
  const { start, end } = getShiftTimeRange();
  if (data.attendance.some(a => a.employeeId === id && a.checkIn >= start && a.checkIn <= end && !a.checkOut))
    return alert("â›” ÄÃ£ vÃ o ca hÃ´m nay.");

  showLoading("ğŸ”„ Äang ghi nháº­n vÃ o ca...");
  data.attendance.push({ employeeId: id, checkIn: roundUp15(new Date()).toISOString(), checkOut: "" });
  await saveData();
  alert("âœ… ÄÃ£ vÃ o ca!");
  await loadData();
  hideLoading();
}

async function checkOut(){
  const id = document.getElementById("employeeSelect").value;
  const { start, end } = getShiftTimeRange();
  const entry = data.attendance.find(a => a.employeeId === id && a.checkIn >= start && a.checkIn <= end && !a.checkOut);
  if (!entry) return alert("KhÃ´ng tÃ¬m tháº¥y ca lÃ m hÃ´m nay.");

  showLoading("ğŸ”„ Äang ghi nháº­n ra ca...");
  entry.checkOut = roundDown15(new Date()).toISOString();
  await saveData();
  alert("â›” ÄÃ£ ra ca!");
  await loadData();
  hideLoading();
}

async function saveData(){
  await fetch(API_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
}
function showLoading(msg = "â³ Äang xá»­ lÃ½...") {
  const el = document.getElementById("loadingOverlay");
  el.textContent = msg;
  el.style.display = "flex";
}

function hideLoading() {
  document.getElementById("loadingOverlay").style.display = "none";
}
</script>
</body>
</html>
