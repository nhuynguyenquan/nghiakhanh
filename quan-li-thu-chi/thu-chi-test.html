<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω thu chi Gia ƒë√¨nh B√† Thu</title>
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6f8;
    }
    nav {
      display: flex;
      justify-content: center;
      background-color: #d9a382;
      padding: 10px;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin: 0 15px;
      font-size: 18px;
    }
    h2 {
      text-align: center;
      color: #d35400;
    }
    label, input, select, button {
      display: block;
      width: 90%;
      margin: 8px auto;
      padding: 8px;
      font-size: 1rem;
    }
    .summary {
      margin: 10px auto;
      text-align: center;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }
    table thead {
      background-color: #eee;
    }
    button {
      padding: 5px 8px;
      font-size: 1rem;
    }
    .month-box {
      border: 1px solid #ccc;
      margin: 10px;
      border-radius: 8px;
      background: #fff;
      overflow: hidden;
    }
    .month-header {
      background: #d35400;
      color: white;
      padding: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .month-header strong {
      font-size: 1rem;
    }
  </style>
  <link rel="manifest" href="../quan-li/manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(registration => {
      console.log('Service Worker ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω:', registration);
    });

    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data && event.data.type === 'NEW_VERSION_AVAILABLE') {
        if (confirm("C√≥ phi√™n b·∫£n m·ªõi c·ªßa ·ª©ng d·ª•ng. B·∫°n c√≥ mu·ªën t·∫£i l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t?")) {
          window.location.reload();
        }
      }
    });
  }
</script>
</head>
<body>
  <nav>
    <a href="../quan-li-thu-chi/">Qu·∫£n L√≠ Thu Chi</a>
    <a href="../quan-li-kho/">Qu·∫£n L√≠ Kho</a>
    <a href="../quan-li-menu/">Qu·∫£n L√≠ Menu</a>
    <a href="../quan-li-nv/">Qu·∫£n L√≠ Nh√¢n Vi√™n</a>
    <a href="../quan-li-sx/">Qu·∫£n L√≠ S·∫£n Xu·∫•t</a>
    <a href="../quan-li-chi-nhanh/">Qu·∫£n L√≠ Chi Nh√°nh</a>
  </nav>

  <h2>Qu·∫£n l√Ω thu chi Gia ƒë√¨nh B√† Thu</h2>

  <label for="amount">S·ªë ti·ªÅn:</label>
  <input type="number" id="amount" placeholder="VD: 100000">
  <label for="type">Lo·∫°i:</label>
  <select id="type">
    <option value="expense">CHI</option>
    <option value="income">Thu</option>
  </select>
  <label for="note">M√¥ t·∫£:</label>
  <input type="text" id="note" placeholder="VD: B√°n h√†ng">
  <button id="submit-btn">Th√™m</button>

  <div class="summary">
    T·ªïng thu: <span id="total-income">0</span> VND | T·ªïng chi: <span id="total-expense">0</span> VND
  </div>
<div id="loading-overlay" style="
  display:none;
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(255,255,255,0.8);
  z-index:9999;
  font-size:24px;
  color:#d35400;
  text-align:center;
  padding-top:20%;
  font-family:sans-serif;">
  ‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...
</div>

  <div id="transaction-container"></div>
<a href="./">Tr·ªü l·∫°i</a>
<script src="../auth.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwwHcVk5efzzlujCXxEcDC4Roe--hLD_V95BGvIcYKC411lli5UMKZUTMIwr3f_6Kn_EQ/exec";

const TELEGRAM_BOT_TOKEN = "7623637573:AAHajhJVvQZXNjA1kJBedtoan5BX85hGF2M";
const TELEGRAM_CHAT_ID = "6249154937";

/* ========= DOM ========= */
const amountInput = document.getElementById("amount");
const typeSelect  = document.getElementById("type");
const noteInput   = document.getElementById("note");
const submitBtn   = document.getElementById("submit-btn");
const container   = document.getElementById("transaction-container");

let transactions = [];

/* ========= AUTH ========= */
function getAuth() {
  return {
    id: getCookie("user_id"),
    token: getCookie("token")
  };
}
/*
function getAuth() {
  return JSON.parse(localStorage.getItem('auth') || '{}');
}
 ========= FETCH ========= */
async function fetchTransactions() {
  const { id, token } = getAuth();
  if (!id || !token) {
    alert("‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p");
    return [];
  }

  try {
    const res = await fetch(`${API_URL}?id=${id}&token=${token}`);
    const data = await res.json();

    if (data.status === "error") {
      alert("‚ùå Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p");
      return [];
    }

    return Array.isArray(data.transactions) ? data.transactions : [];
  } catch (e) {
    console.error("Fetch error:", e);
    return [];
  }
}

/* ========= SAVE ========= */
function postData(payload) {
  return fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
}

async function saveTransaction(t) {
  const auth = getAuth();
  await postData({ ...auth, transaction: t });
}

async function saveAllTransactions() {
  const auth = getAuth();
  await postData({ ...auth, transactions });
}

/* ========= UI ========= */
function updateUI() {
  container.innerHTML = "";
  let totalIncome = 0, totalExpense = 0;
  const grouped = {};

  transactions.forEach(t => {
    const m = t.date.slice(0,7);
    (grouped[m] ||= []).push(t);
  });

  Object.keys(grouped).sort().reverse().forEach(month => {
    let inc = 0, exp = 0;

    grouped[month].forEach(t =>
      t.type === "income" ? inc += t.amount : exp += t.amount
    );

    totalIncome += inc;
    totalExpense += exp;

    const box = document.createElement("div");
    box.className = "month-box";

    const header = document.createElement("div");
    header.className = "month-header";
    header.innerHTML = `üìÖ ${month} | Thu ${inc.toLocaleString()} | Chi ${exp.toLocaleString()}`;

    const table = document.createElement("table");
    table.style.display = "none";
    table.innerHTML = `<thead><tr>
      <th>S·ªë ti·ªÅn</th><th>Lo·∫°i</th><th>M√¥ t·∫£</th><th>Ng√†y</th><th></th>
    </tr></thead><tbody></tbody>`;

    grouped[month].forEach(t => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.amount.toLocaleString()}</td>
        <td>${t.type}</td>
        <td>${t.note}</td>
        <td>${new Date(t.date).toLocaleString("vi-VN")}</td>
        <td>
          <button onclick="deleteTransaction(${transactions.indexOf(t)})">üóëÔ∏è</button>
        </td>`;
      table.querySelector("tbody").appendChild(tr);
    });

    header.onclick = () => {
      table.style.display = table.style.display === "none" ? "table" : "none";
    };

    box.append(header, table);
    container.appendChild(box);
  });

  document.getElementById("total-income").textContent  = totalIncome.toLocaleString();
  document.getElementById("total-expense").textContent = totalExpense.toLocaleString();
}

/* ========= CRUD ========= */
async function addTransaction() {
  const amount = parseInt(amountInput.value);
  if (!amount) return alert("Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá");

  const t = {
    amount,
    type: typeSelect.value,
    note: noteInput.value,
    date: new Date().toISOString()
  };

  showLoading("üîÑ ƒêang l∆∞u...");
  await saveTransaction(t);
  transactions = await fetchTransactions();
  updateUI();
  sendToTelegram(t);
  resetForm();
  hideLoading();
}

async function deleteTransaction(i) {
  if (!confirm("X√≥a giao d·ªãch?")) return;
  transactions.splice(i, 1);
  await saveAllTransactions();
  updateUI();
}

/* ========= UTIL ========= */
function resetForm() {
  amountInput.value = "";
  noteInput.value = "";
  typeSelect.value = "income";
}

function showLoading(t="‚è≥ ƒêang x·ª≠ l√Ω...") {
  const o = document.getElementById("loading-overlay");
  o.textContent = t;
  o.style.display = "block";
}
function hideLoading() {
  document.getElementById("loading-overlay").style.display = "none";
}

/* ========= TELEGRAM ========= */
function sendToTelegram(t) {
  fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: TELEGRAM_CHAT_ID,
      text: `üí∞ ${t.amount.toLocaleString()} VND\nüìÇ ${t.type}\nüìù ${t.note}`
    })
  });
}

/* ========= INIT ========= */
window.onload = async () => {
  submitBtn.onclick = addTransaction;
  showLoading();
  transactions = await fetchTransactions();
  updateUI();
  hideLoading();
};
</script>
</body>
</html>