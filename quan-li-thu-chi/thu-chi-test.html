<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω Thu Chi ‚Äì Gia ƒë√¨nh B√† Thu</title>

  <meta name="theme-color" content="#d35400" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      background: #f4f6f8;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 14px;
      background: #d35400;
      padding: 10px;
      flex-wrap: wrap;
    }

    nav a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
    }

    h2 {
      text-align: center;
      color: #d35400;
      margin: 16px 0;
    }

    label, input, select, button {
      display: block;
      width: 90%;
      max-width: 420px;
      margin: 8px auto;
      padding: 8px;
      font-size: 1rem;
    }

    button {
      background: #d35400;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .summary {
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
    }

    .month-box {
      background: #fff;
      margin: 12px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ddd;
    }

    .month-header {
      background: #d35400;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 0.95rem;
    }

    th {
      background: #f1f1f1;
    }

    #loading {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.85);
      font-size: 22px;
      color: #d35400;
      text-align: center;
      padding-top: 20%;
      z-index: 9999;
    }
  </style>
</head>

<body>

<nav>
  <a href="#">Thu Chi</a>
  <a href="../quan-li-kho/">Kho</a>
  <a href="../quan-li-menu/">Menu</a>
  <a href="../quan-li-nv/">Nh√¢n vi√™n</a>
</nav>

<h2>Qu·∫£n l√Ω Thu Chi ‚Äì Gia ƒë√¨nh B√† Thu</h2>

<label>S·ªë ti·ªÅn</label>
<input id="amount" type="number" placeholder="VD: 100000" />

<label>Lo·∫°i</label>
<select id="type">
  <option value="income">Thu</option>
  <option value="expense">Chi</option>
</select>

<label>M√¥ t·∫£</label>
<input id="note" placeholder="VD: B√°n h√†ng" />

<button id="submit-btn">Th√™m giao d·ªãch</button>

<div class="summary">
  T·ªïng thu: <span id="total-income">0</span> |
  T·ªïng chi: <span id="total-expense">0</span>
</div>

<div id="transaction-container"></div>

<div id="loading">‚è≥ ƒêang x·ª≠ l√Ω...</div>

<script>
/* ================== CONFIG ================== */
const API_URL = "https://script.google.com/macros/s/AKfycbx8Tpqq5v6k45i5KGF__GtdWzQSua9kNs3TFRNRQnKP3bMvAEOocJBDj8Ty-oIhIlI-zA/exec";

/* ================== STATE ================== */
let transactions = [];

/* ================== UTIL ================== */
const $ = id => document.getElementById(id);

function showLoading(text = "‚è≥ ƒêang x·ª≠ l√Ω...") {
  const l = $("loading");
  l.textContent = text;
  l.style.display = "block";
}

function hideLoading() {
  $("loading").style.display = "none";
}

/* ================== API ================== */
async function fetchTransactions() {
  const res = await fetch(API_URL);
  const data = await res.json();
  return data.transactions || [];
}

async function saveTransaction(transaction) {
  await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ transaction })
  });
}

/* ================== UI ================== */
function updateUI() {
  const box = $("transaction-container");
  box.innerHTML = "";

  let totalIncome = 0;
  let totalExpense = 0;

  const groups = {};

  transactions.forEach(t => {
    const m = t.date.slice(0, 7);
    groups[m] ??= [];
    groups[m].push(t);
  });

  Object.keys(groups).sort().reverse().forEach(month => {
    const list = groups[month].sort((a,b)=>new Date(b.date)-new Date(a.date));

    let inc = 0, exp = 0;
    list.forEach(t => t.type === "income" ? inc += t.amount : exp += t.amount);
    totalIncome += inc;
    totalExpense += exp;

    const wrap = document.createElement("div");
    wrap.className = "month-box";

    const head = document.createElement("div");
    head.className = "month-header";
    head.innerHTML = `<strong>${month} | Thu: ${inc.toLocaleString()} ‚Äì Chi: ${exp.toLocaleString()}</strong><span>üîΩ</span>`;

    const table = document.createElement("table");
    table.style.display = "none";
    table.innerHTML = `
      <thead>
        <tr><th>S·ªë ti·ªÅn</th><th>Lo·∫°i</th><th>M√¥ t·∫£</th><th>Ng√†y</th></tr>
      </thead>
      <tbody>
        ${list.map(t => `
          <tr>
            <td>${t.amount.toLocaleString()}</td>
            <td>${t.type === "income" ? "Thu" : "Chi"}</td>
            <td>${t.note}</td>
            <td>${new Date(t.date).toLocaleString("vi-VN")}</td>
          </tr>`).join("")}
      </tbody>
    `;

    head.onclick = () => {
      table.style.display = table.style.display === "none" ? "table" : "none";
    };

    wrap.append(head, table);
    box.appendChild(wrap);
  });

  $("total-income").textContent = totalIncome.toLocaleString();
  $("total-expense").textContent = totalExpense.toLocaleString();
}

/* ================== ACTION ================== */
async function addTransaction() {
  const amount = parseInt($("amount").value);
  const type = $("type").value;
  const note = $("note").value.trim();

  if (!amount || amount <= 0) {
    alert("Nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá");
    return;
  }

  showLoading("üîÑ ƒêang l∆∞u...");
  $("submit-btn").disabled = true;

  const t = {
    amount,
    type,
    note,
    date: new Date().toISOString()
  };

  await saveTransaction(t);
  transactions.unshift(t);
  updateUI();

  $("amount").value = "";
  $("note").value = "";
  $("submit-btn").disabled = false;
  hideLoading();
}

/* ================== INIT ================== */
window.onload = async () => {
  showLoading("‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...");
  transactions = await fetchTransactions();
  updateUI();
  hideLoading();

  $("submit-btn").onclick = addTransaction;
};
</script>

</body>
</html>
