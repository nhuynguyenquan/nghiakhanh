<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý bán hàng & kho</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    h2 { color: #2c3e50; }
    label, select, input { display: block; margin: 10px 0; width: 100%; }
    button { padding: 10px; background: #27ae60; color: white; border: none; cursor: pointer; }
    button:hover { background: #219150; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  </style>
</head>
<body>

  <h2>Bán hàng</h2>
  <form id="saleForm">
    <label for="item">Chọn món:</label>
    <select id="item" required></select>

    <label for="quantity">Số lượng:</label>
    <input type="number" id="quantity" required min="1">

    <button type="submit">Bán hàng</button>
  </form>

  <h2>Lịch sử bán hàng</h2>
  <table id="salesTable">
    <thead>
      <tr><th>Thời gian</th><th>Món</th><th>Số lượng</th><th>Thành tiền</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwtYHiBJ3ShQK7Ypn43vjf7sgF6KpZecdU-7-a5cpFN90smOUODSVMOMxb_dRUBiJQ0/exec";

    let items = [];

    async function loadData() {
      const res = await fetch(API_URL);
      const data = await res.json();
      items = data.items || [];

      const itemSelect = document.getElementById("item");
      itemSelect.innerHTML = items.map(i => `<option value="${i.name}">${i.name} (Còn: ${i.stock})</option>`).join("");

      const tbody = document.querySelector("#salesTable tbody");
      tbody.innerHTML = (data.sales || []).map(s => `
        <tr>
          <td>${new Date(s.date).toLocaleString()}</td>
          <td>${s.item}</td>
          <td>${s.quantity}</td>
          <td>${s.total.toLocaleString()}₫</td>
        </tr>
      `).join("");
    }

    document.getElementById("saleForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const itemName = document.getElementById("item").value;
      const quantity = parseInt(document.getElementById("quantity").value);
      const item = items.find(i => i.name === itemName);
      if (!item || quantity <= 0) return alert("Dữ liệu không hợp lệ.");

      if (quantity > item.stock) {
        return alert(`❌ Không đủ hàng. Chỉ còn ${item.stock} cái.`);
      }

      const transaction = {
        item: itemName,
        quantity,
        total: item.price * quantity
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ transaction })
      });

      const text = await res.text();
      alert(text);
      loadData();
    });

    loadData();
  </script>
</body>
</html>
