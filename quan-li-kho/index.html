<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n L√Ω Kho - Nh·ª•y Nguy√™n</title>
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6f8;
    }
    .container {
      max-width: 480px;
      margin: auto;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #d35400;
    }
    .section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      margin-bottom: 15px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #27ae60;
      color: white;
      border: none;
      transition: 0.2s;
    }
    button:hover {
      background: #219150;
    }
    .log {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üì¶ Qu·∫£n L√Ω Kho - Nh·ª•y Nguy√™n</h2>

    <div class="section">
      <h3>‚ûï Th√™m H√†ng M·ªõi</h3>
      <input type="text" id="itemName" placeholder="T√™n h√†ng">
      <input type="number" id="itemQty" placeholder="S·ªë l∆∞·ª£ng ban ƒë·∫ßu">
      <button onclick="addItem()">Th√™m v√†o kho</button>
    </div>

    <div class="section">
      <h3>üîÅ Nh·∫≠p / Xu·∫•t Kho</h3>
      <select id="itemSelect"></select>
      <input type="number" id="qtyChange" placeholder="S·ªë l∆∞·ª£ng thay ƒë·ªïi">
      <select id="actionType">
        <option value="import">Nh·∫≠p h√†ng</option>
        <option value="export">Xu·∫•t h√†ng</option>
      </select>
      <button onclick="updateStock()">C·∫≠p nh·∫≠t</button>
    </div>

    <div class="section">
      <h3>üìã H√†ng T·ªìn Kho</h3>
      <ul id="stockList"></ul>
    </div>

    <div class="section">
      <h3>üïí L·ªãch S·ª≠ Giao D·ªãch</h3>
      <div class="log" id="logHistory"></div>
    </div>
  </div>
  <script>
    let stock = {};
    let history = [];
    const APP_KEY = '91gch0ud8qxqd26';  // Replace with your Dropbox app key
    const CLIENT_SECRET = '0bkwykqkfbxu4en';  // Replace with your Dropbox app secret
    const REDIRECT_URI = 'https://nhuynguyenquan.github.io/nghiakhanh/quan-li-kho/';

    // Function to get the access token from Dropbox
    async function getAccessToken(code) {
        const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                code: code,
                grant_type: 'authorization_code',
                client_id: APP_KEY,
                client_secret: CLIENT_SECRET,
                redirect_uri: REDIRECT_URI,
            }),
        });

        const data = await response.json();
        console.log('Access Token:', data);
        return data.access_token;
    }

    // URL for Dropbox OAuth authentication
    const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${APP_KEY}&response_type=code&redirect_uri=${REDIRECT_URI}`;

    // Trigger the authentication flow by redirecting to Dropbox's OAuth URL
    if (!window.location.search.includes('code=')) {
        window.location.href = authUrl;
    } else {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        if (code) {
            getAccessToken(code).then(token => {
                console.log('Authenticated with token:', token);
                // Now you can proceed with file operations using Dropbox API
            });
        }
    }

    // Initialize Dropbox API with access token
    const DROPBOX_ACCESS_TOKEN = 'sl.u.AFpXOirhlAg738ZDWSD3V5nKqMzJkFqPm1r0WcguYbSQJYXkGtSICLbQsAWrZGV0x9FSsknwpe_TFqYo40z45MgdO1-JDzbHyfq52ETtnou7kVd-StkzhSocGXDoQzfofMO8RlbGsAnGaYMmgRsjW8jYhT7tfg-VUSTi22SGuz5c7U0VVGJzGphpwRKptIJhGDy1vxzX-Jq4KxtkaFGXGHDbIBvpc4Yc-J9bgCm4tsbgChiR2bRszyIMfRe9DCsO1CHf3DnNS_xkKP-zfcKoKKoGbJ8iCZO4PfoProPtUOUVVGH-9ePn5dccj5HlsQ6nZu6XUieJxN6e1xZYjspUp_Rl7muN4JmOnany0vdARMaMRzpD2RpBUMllEDXJ-zXRnhc-2iv69odpwPsMnozFCGLiqkqzJLj6MqNX9KuC_bsngCWUd0aGBv6HiIBsFwoBjsFyRtl6rI9OcyaUfBnP8Ei25bUXqCv0R7qG7sTJISB2uyZwjZxmO_ryLdEIB9ZSicRK8VdQq2MNw4o_UrzKjI-DSYVdbLA7iUDgA4TNtbX-P2zjGHnJXk7LQzt6dFmFkZPU6J4d8DzLOvRfy95CYQJR8XAbSzgfjYFPRYDc09s8I2-6tFL4vHKL2nLo4vnG9Kd9YE6yW-itC6-MWDyh-CCV5MDMCWMlfIpZA08UxFsl-SsaBAzHELmdtI4Ot9uPOekNRy36OjUIDZ5bZge4LoolOKoKUmpWDmUIFeFnriIjwJesZ5MhOx90l-ISXAXow1EtLR-pkv-pkDkcKGcqwrNtnZMA3hJE0BMiuq1t4c_BlMY-SkLCiBE8Nuj758Fl1lZjWRiN5eYOT4rWvsQiC4Yn5DGQInx9m9GRqBCQg6rKPiwOWQhwkOvHNCS-Lk8qAk0e14fZqnzCLsUu8wJqC2zg4FMyLQ6Bofwy2pXpuUCTDIfXzqGmUgbfatXC3g0mKxjxdL2sNxc-azOqZIex24fiKAcZ7RqWkGRpV5D_zx4gPtoEYVKK5G5RBj11aAZZDYQ7vSiP9heNZRGGDFxgH93DuLvL9XQg8Pp6uEBGDe5z0_PMDBNIcYseRwQtjpH6Bt40q6m67KaXsOdYw6DpvkWf-D0C-WGoGSy3Z6orJFtf_EgPqu7SK1uo0nMnWF1BkLoOAuGxhhQHaw-Urj4sfxaXOqtjO6ZeoWPm0lNclToJ6cx0Y6sP4Tiuw0ccDh9XbZxIUM0j4_c1fFs1_-gMzqMw3omqSrEjBi-OaHRQ2nLaTMFJdb9QhK_Xr261iB3-5kQ';

    const dbx = new Dropbox.Dropbox({ accessToken: DROPBOX_ACCESS_TOKEN });

    // Function to load data from Dropbox
    async function loadData() {
    try {
        const response = await dbx.filesDownload({ path: '/kho/kho.json' });
        const jsonData = await response.fileBlob.text();
        const data = JSON.parse(jsonData);
        if (!data || !data.stock) {
            console.error('Stock data is missing.');
            return { stock: {}, history: [] }; // Return empty stock and history if data is missing
        }
        return data;
    } catch (error) {
        console.error('Error loading data:', error);
        return { stock: {}, history: [] }; // Fallback to empty data
    }
}

    // Function to render stock data to the screen
    function renderStock() {
        const list = document.getElementById("stockList");
        const select = document.getElementById("itemSelect");
        list.innerHTML = "";
        select.innerHTML = "";

        for (const item in stock) {
            list.innerHTML += `<li>${item}: ${stock[item]}</li>`;
            select.innerHTML += `<option value="${item}">${item}</option>`;
        }
    }

    // Function to render the history log
    function renderHistory() {
        const log = document.getElementById("logHistory");
        log.innerHTML = "";
        history.slice().reverse().forEach(entry => {
            log.innerHTML += `<div class="log-entry">üì¶ <strong>${entry.item}</strong> | ${entry.action === 'import' ? '‚ûï' : '‚ûñ'} ${entry.qty} | üïí ${entry.time}</div>`;
        });
    }

    // Function to save data back to Dropbox
    async function saveData(stock, history) {
        const data = { stock, history };
        const jsonData = JSON.stringify(data, null, 2);

        try {
            const response = await dbx.filesUpload({
                path: '/kho/kho.json', // Path to the kho.json file on Dropbox
                contents: jsonData,
                mode: 'overwrite' // Overwrite the file if it already exists
            });
            console.log('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t:', response);
        } catch (error) {
            console.error('L·ªói khi ghi d·ªØ li·ªáu:', error);
        }
    }

    // Function to add an item to the stock
    async function addItem() {
        const name = document.getElementById("itemName").value.trim();
        const qty = parseInt(document.getElementById("itemQty").value);

        if (!name || isNaN(qty)) return alert("Vui l√≤ng nh·∫≠p t√™n v√† s·ªë l∆∞·ª£ng");

        const data = await loadData();
        const stock = data.stock || {};
        const history = data.history || [];

        // Update stock
        stock[name] = qty;

        // Update history
        history.push({ item: name, qty, action: 'import', time: new Date().toLocaleString() });

        // Save data back to Dropbox
        await saveData(stock, history);
        renderStock();  // Update the UI
        renderHistory();
    }

    // Function to update the stock
    async function updateStock() {
        const item = document.getElementById("itemSelect").value;
        const qty = parseInt(document.getElementById("qtyChange").value);
        const action = document.getElementById("actionType").value;

        if (!item || isNaN(qty)) return alert("Vui l√≤ng nh·∫≠p th√¥ng tin ƒë·∫ßy ƒë·ªß");
        if (action === "export" && stock[item] < qty) return alert("Kh√¥ng ƒë·ªß h√†ng");

        stock[item] += (action === "import" ? qty : -qty);
        history.push({ item, qty, action, time: new Date().toLocaleString() });

        renderStock();
        renderHistory();
        await saveData(stock, history);

        document.getElementById("qtyChange").value = "";
    }

    // Initialize the stock data
    loadData().then(data => {
        stock = data.stock || {};
        history = data.history || [];
        renderStock();
        renderHistory();
    });
    async function checkFileAccess(accessToken) {
  const response = await fetch('https://api.dropboxapi.com/2/files/get_metadata', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      path: '/kho/kho.json',  // ƒê∆∞·ªùng d·∫´n t·ªáp b·∫°n mu·ªën ki·ªÉm tra quy·ªÅn truy c·∫≠p
    }),
  });

  const data = await response.json();
  console.log(data);
  if (data.error) {
    console.error('Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p t·ªáp:', data.error);
  } else {
    console.log('T·ªáp c√≥ s·∫µn v√† b·∫°n c√≥ quy·ªÅn truy c·∫≠p:', data);
  }
}
</script>

</body>
</html>
