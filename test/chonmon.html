<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chọn món</title>
<style>
body { font-family: sans-serif; padding: 1rem; background: #f9f9f9; }
h1 { color: #ff914d; }
.menu-item { margin: 0.5rem 0; padding: 0.5rem; background: #fff; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
button { margin-left: 1rem; }
#cart { margin-top: 1rem; background: #fff; padding: 0.5rem; border-radius: 5px; }
</style>
</head>
<body>
<h1 id="shop-name">Menu</h1>
<div id="menu-list"></div>
<div id="cart">
  <h3>Giỏ hàng</h3>
  <div id="cart-items"></div>
  <button onclick="submitOrder()">Gửi đơn</button>
</div>

<script>
let cart = [];

async function loadMenu() {
  const params = new URLSearchParams(window.location.search);
  const shopId = params.get('id');
  const token = params.get('token');

  if (!shopId || !token) {
    document.body.innerHTML = "<p>Thiếu ID quán hoặc token!</p>";
    return;
  }

  // Kiểm tra token
  const check = await fetch(`https://script.google.com/macros/s/AKfycbxEZu7g5ZldB0x4Ym6ccBmwIFC1qbrLne8pbZCBMeldEVVwV8YvJM2d1Qs5hRQkKrUEVA/exec?checkToken=${token}`);
  const valid = await check.text();
  if (valid !== "VALID") {
    document.body.innerHTML = "<p>Token không hợp lệ hoặc đã hết hạn!</p>";
    return;
  }

  // Load menu
  const menuData = await fetch('https://script.google.com/macros/s/AKfycbzO6rW0tFa5QAKgV2kdrQ9v1Ux7ISUQdg3ri6D9uDViI0u8m2k7sLRfrW58Z2G4rOh2Pw/exec'); 
  const data = await menuData.json();
  const shop = data.shops.find(s => s.id === shopId);
  if (!shop) {
    document.body.innerHTML = "<p>Quán không tồn tại!</p>";
    return;
  }

  document.getElementById('shop-name').textContent = shop.name;

  const menuList = document.getElementById('menu-list');
  shop.menu.forEach(item => {
    const div = document.createElement('div');
    div.className = "menu-item";
    div.innerHTML = `${item.item} - ${item.price}₫ <button onclick="addToCart('${item.item}', ${item.price})">Chọn</button>`;
    menuList.appendChild(div);
  });

  function addToCart(name, price) {
    const found = cart.find(i => i.name === name);
    if (found) found.quantity += 1;
    else cart.push({ name, price, quantity: 1 });
    renderCart();
  }

  window.addToCart = addToCart; // expose function
}

function renderCart() {
  const div = document.getElementById('cart-items');
  div.innerHTML = '';
  cart.forEach(it => {
    const p = document.createElement('p');
    p.textContent = `${it.name} x${it.quantity} - ${it.price}₫`;
    div.appendChild(p);
  });
}

async function submitOrder() {
  const params = new URLSearchParams(window.location.search);
  const shopId = params.get('id');
  const token = params.get('token');

  if (!cart.length) { alert('Chưa chọn món!'); return; }

  const res = await fetch('https://script.google.com/macros/s/AKfycbzO6rW0tFa5QAKgV2kdrQ9v1Ux7ISUQdg3ri6D9uDViI0u8m2k7sLRfrW58Z2G4rOh2Pw/exec', {
    method: 'POST',
    
    body: JSON.stringify({ id: shopId, token, items: cart })
  });
  const text = await res.text();
  alert(text === "OK" ? "Đơn đã gửi!" : "Gửi đơn thất bại: " + text);
  cart = [];
  renderCart();
}

loadMenu();
</script>
</body>
</html>
