<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chọn món</title>
<style>
body { font-family: sans-serif; padding: 1rem; background: #f9f9f9; }
h1 { color: #ff914d; }
.menu-item { margin: 0.5rem 0; padding: 0.5rem; background: #fff; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
button { margin-left: 1rem; }
#cart { margin-top: 1rem; background: #fff; padding: 0.5rem; border-radius: 5px; }
</style>
</head>
<body>
<h1 id="shop-name">Menu</h1>
<div id="menu-list"></div>
<div id="cart">
  <h3>Giỏ hàng</h3>
  <div id="cart-items"></div>
  <button onclick="submitOrder()">Gửi đơn</button>
</div>

<script>
let cart = [];

function getParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

const shopId = getParam('id');
const token = getParam('token');
if(!shopId || !token){
  document.body.innerHTML = "<p>Thiếu ID quán hoặc token!</p>";
}

// --- JSONP callback cho CORS ---
function loadMenuJSONP(data){
  if(!data || !data.shops) {
    document.body.innerHTML = "<p>Không lấy được menu!</p>";
    return;
  }
  const shop = data.shops.find(s => s.id === shopId);
  if(!shop){
    document.body.innerHTML = "<p>Quán không tồn tại!</p>";
    return;
  }
  document.getElementById('shop-name').textContent = shop.name;
  const menuList = document.getElementById('menu-list');
  shop.menu.forEach(item => {
    const div = document.createElement('div');
    div.className = "menu-item";
    div.innerHTML = `${item.item} - ${item.price}₫ <button onclick="addToCart('${encodeURIComponent(item.item)}', ${item.price})">Chọn</button>`;
    menuList.appendChild(div);
  });
}

// thêm món vào giỏ
function addToCart(name, price){
  name = decodeURIComponent(name);
  const found = cart.find(i=>i.name===name);
  if(found) found.quantity +=1;
  else cart.push({name, price, quantity:1});
  renderCart();
}

window.addToCart = addToCart;

function renderCart(){
  const div = document.getElementById('cart-items');
  div.innerHTML = '';
  let total = 0;
  cart.forEach(it=>{
    const p = document.createElement('p');
    p.textContent = `${it.name} x${it.quantity} - ${it.price*it.quantity}₫`;
    div.appendChild(p);
    total += it.price*it.quantity;
  });
  const t = document.createElement('p');
  t.innerHTML = `<strong>Tổng: ${total}₫</strong>`;
  div.appendChild(t);
}

// load menu bằng JSONP
function loadMenu(){
  const script = document.createElement('script');
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxXfBuxVuooLolfvbx9CMQ9KSFWFbDYVSjOC9q-uIZYKVGxWJ1Z9poMZdCbp3epUTnCtQ/exec"; 
  script.src = `${GAS_URL}?callback=loadMenuJSONP`;
  document.body.appendChild(script);
}

// gửi đơn hàng (POST, no-cors)
function submitOrder(){
  if(!cart.length){ alert('Chưa chọn món!'); return; }
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxXfBuxVuooLolfvbx9CMQ9KSFWFbDYVSjOC9q-uIZYKVGxWJ1Z9poMZdCbp3epUTnCtQ/exec"; 

  const payload = {id: shopId, token, items: cart};

  // POST dạng fetch, mode no-cors (không đọc response)
  fetch(GAS_URL, {
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  }).catch(()=>{});
  
  alert('Đơn đã gửi!');
  cart=[];
  renderCart();
}

loadMenu();
</script>
</body>
</html>
