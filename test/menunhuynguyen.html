<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ch·ªçn m√≥n </title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:0; padding:0; background:#fafafa;}
h1 {text-align:center; padding:1rem; background:#ff914d; color:#fff; margin:0; font-size:1.3rem;}
.container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
  gap: 0.8rem;
  padding: 0.8rem;
  padding-bottom: 220px; /* chi·ªÅu cao gi·ªè h√†ng + margin */
}
.cart {
  background: #fff;
  border-top: 2px solid #ff914d;
  padding: 0.8rem;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  max-height: 200px; /* gi·ªõi h·∫°n chi·ªÅu cao gi·ªè h√†ng */
  overflow-y: auto;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  z-index: 100; /* ƒë·∫£m b·∫£o lu√¥n hi·ªÉn th·ªã tr√™n menu */
}
.item {background:#fff; border:1px solid #ddd; border-radius:10px; overflow:hidden; cursor:pointer; transition:transform 0.15s; display:flex; flex-direction:column;}
.item:active {transform:scale(0.97);}
.thumb {width:100%; height:100px; object-fit:cover;}
.label {padding:0.4rem; font-weight:600; text-align:center; font-size:0.9rem;}
.price {padding-bottom:0.6rem; text-align:center; color:#555; font-size:0.85rem;}

.cart h2 {margin:0 0 0.5rem; font-size:1.1rem;}
.cart-item {display:flex; align-items:center; padding:0.4rem 0; border-bottom:1px solid #eee; font-size:0.9rem; gap:0.5rem;}
.cart-item .name {flex:2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
.cart-item .quantity-controls {flex:1; display:flex; justify-content:center; align-items:center; gap:0.3rem;}
.cart-item .quantity-controls button {width:28px; height:28px; padding:0; font-size:1rem;}
.cart-item .item-total {flex:1; text-align:right; white-space: nowrap;}
.total {font-weight:bold; text-align:right; margin-top:0.5rem; font-size:1rem;}
.send-btn, .view-orders-btn {width:100%; padding:0.8rem; margin-top:0.5rem; border:none; font-size:1rem; border-radius:6px; cursor:pointer;}
.send-btn {background:#28a745; color:white;}
.view-orders-btn {background:#007bff; color:white;}
.send-btn .spinner {border:2px solid #fff; border-top:2px solid rgba(255,255,255,0.5); border-radius:50%; width:16px; height:16px; display:inline-block; margin-right:8px; vertical-align:middle; animation:spin 0.8s linear infinite;}
@keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}
@media(max-width:400px){.thumb{height:80px;} .label{font-size:0.85rem;} .price{font-size:0.8rem;}}
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;}
.modal-content {background:#fff; padding:1rem; border-radius:10px; max-width:400px; width:90%; max-height:80%; overflow-y:auto;}
.modal-content h3 {margin-top:0;}
.modal-content button {margin-top:0.5rem; padding:0.5rem 1rem; border:none; border-radius:5px; background:#ff914d; color:#fff; cursor:pointer;}
</style>
</head>
<body>

<h1>MENU</h1>
<div style="background:#fff; padding:0.8rem; margin:0.8rem; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1); font-size:0.9rem; line-height:1.4;">
  <strong>H∆∞·ªõng d·∫´n ƒë·∫∑t m√≥n:</strong>
  <ol style="padding-left:1.2rem; margin:0.5rem 0;">
    <li>Ch·∫°m v√†o m√≥n b·∫°n mu·ªën ch·ªçn ƒë·ªÉ th√™m v√†o gi·ªè h√†ng.</li>
    <li>Trong gi·ªè h√†ng, b·∫•m <strong>+</strong> ho·∫∑c <strong>-</strong> ƒë·ªÉ ƒëi·ªÅu ch·ªânh s·ªë l∆∞·ª£ng.</li>
    <li>Xem t·ªïng ti·ªÅn ·ªü cu·ªëi gi·ªè h√†ng.</li>
    <li>B·∫•m n√∫t <strong>G·ª≠i ƒë∆°n</strong> ƒë·ªÉ ƒë·∫∑t m√≥n. B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi g·ª≠i th√†nh c√¥ng.</li>
    <li>B·∫•m <strong>Xem ƒë∆°n ƒë√£ ƒë·∫∑t</strong> ƒë·ªÉ ki·ªÉm tra c√°c ƒë∆°n ƒë√£ g·ª≠i.</li>
    <li>N·∫øu link h·∫øt h·∫°n, vui l√≤ng qu√©t l·∫°i QR ƒë·ªÉ l·∫•y link m·ªõi.</li>
    <li>Ho·∫∑c qu√Ω kh√°ch li√™n h·ªá t·ªõi Zalo Facebook ƒë·ªÉ ch·ªçn m√≥n <br> <p>üëâ <a href="https://zalo.me/0349969537" target="_blank">Chat Zalo</a> |  
        <a href="https://m.me/nhuynguyenquan88" target="_blank">Chat Messenger</a></p></li>
  </ol>
</div>

<div class="container" id="menuList"></div>

<div class="cart" id="cart">
  <h2>Gi·ªè h√†ng</h2>
  <div id="cartItems"></div>
  <div class="total" id="cartTotal">T·ªïng: 0ƒë</div>
  <button class="send-btn" id="sendBtn" onclick="sendOrder()">G·ª≠i ƒë∆°n</button>
  <button class="view-orders-btn" onclick="showOrders()">Xem ƒë∆°n ƒë√£ ƒë·∫∑t</button>
</div>

<!-- Modal xem ƒë∆°n -->
<div id="orderModal" class="modal">
  <div class="modal-content">
    <h3>ƒê∆°n h√†ng ƒë√£ g·ª≠i</h3>
    <div id="orderList"></div>
    <button onclick="closeModal()">ƒê√≥ng</button>
  </div>
</div>

<script>
const cart = {};
let sentOrders = [];
const params = new URLSearchParams(window.location.search);
const branchId = params.get("id");
const token = params.get("token");
if(!branchId || !token) alert("Link ƒë√£ h·∫øt h·∫°n, vui l√≤ng qu√©t QR ƒë·ªÉ l·∫•y link m·ªõi!");
const GAS_URL = "https://script.google.com/macros/s/AKfycby-FmUQpiz4pnf0LYd2Rxuhxu5mS2Y44aDlKb8TVpFGwlo9TqA5Tp1YTDFhrcncWoAxZA/exec";

// th·ªùi h·∫°n l∆∞u ƒë∆°n (ms) ‚Äì v√≠ d·ª•: 24h
const ORDER_EXPIRY = 3 * 60 * 60 * 1000;

// n·∫°p l·∫°i ƒë∆°n ƒë√£ g·ª≠i t·ª´ localStorage (l·ªçc b·ªè ƒë∆°n qu√° h·∫°n)
(function loadOrders(){
  const raw = JSON.parse(localStorage.getItem("orders_"+branchId) || "[]");
  const now = Date.now();
  sentOrders = raw.filter(o => now - (o.savedAt || 0) < ORDER_EXPIRY);
  // n·∫øu c√≥ ƒë∆°n b·ªã qu√° h·∫°n th√¨ c·∫≠p nh·∫≠t l·∫°i storage
  if(sentOrders.length !== raw.length){
    localStorage.setItem("orders_"+branchId, JSON.stringify(sentOrders));
  }
})();

async function renderMenu() {
  try{
    const res = await fetch(`${GAS_URL}?id=${branchId}&token=${token}`);
    const data = await res.json();
    if(data.status === "error") { alert("L·ªói: "+data.message); return; }
    const menuList = document.getElementById("menuList");
    data.menu.forEach(item => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<img class="thumb" src="${item.img}" alt="${item.name}" />
                       <div class="label">${item.name}</div>
                       <div class="price">${item.price.toLocaleString()}ƒë</div>`;
      div.onclick = ()=>addToCart(item);
      menuList.appendChild(div);
    });
  }catch(err){ alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c menu: "+err.message); }
}

function addToCart(item){
  if(!cart[item.id]) cart[item.id] = {...item, quantity:1};
  else cart[item.id].quantity++;
  renderCart();
}

function changeQuantity(id, delta){
  if(cart[id]){
    cart[id].quantity += delta;
    if(cart[id].quantity<=0) delete cart[id];
    renderCart();
  }
}

function renderCart(){
  const cartItems = document.getElementById("cartItems");
  cartItems.innerHTML="";
  let total=0;
  Object.values(cart).forEach(item=>{
    total += item.price*item.quantity;
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `<span class="name" title="${item.name}">${item.name}</span>
                     <div class="quantity-controls">
                       <button onclick="changeQuantity('${item.id}',-1)">-</button>
                       <span>${item.quantity}</span>
                       <button onclick="changeQuantity('${item.id}',1)">+</button>
                     </div>
                     <span class="item-total">${(item.price*item.quantity).toLocaleString()}ƒë</span>`;
    cartItems.appendChild(div);
  });
  document.getElementById("cartTotal").innerText = "T·ªïng: "+total.toLocaleString()+"ƒë";
}

async function sendOrder(){
  if(Object.keys(cart).length===0){ alert("Gi·ªè h√†ng tr·ªëng!"); return; }
  const btn = document.getElementById("sendBtn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>ƒêang g·ª≠i...';
  const order = {
    items:Object.values(cart),
    total:Object.values(cart).reduce((sum,i)=>sum+i.price*i.quantity,0),
    time:new Date().toLocaleString("vi-VN"),
    savedAt: Date.now()   // th√™m timestamp
  };
  try{
    const res = await fetch(`${GAS_URL}?id=${branchId}&token=${token}`, {
      method:"POST",
      body:JSON.stringify(order)
    });
    const data = await res.json();
    if(data.status==="success"){
      const savedOrder = {...order, id:data.order.id};
      sentOrders.push(savedOrder);
      localStorage.setItem("orders_"+branchId, JSON.stringify(sentOrders));
      alert("ƒê√£ g·ª≠i ƒë∆°n th√†nh c√¥ng!");
      for(let k in cart) delete cart[k];
      renderCart();
    }else alert("L·ªói: "+data.message);
  }catch(err){ alert("Link ƒë√£ h·∫øt h·∫°n, vui l√≤ng qu√©t QR ƒë·ªÉ l·∫•y link m·ªõi!"); }
  finally{ btn.disabled=false; btn.innerText="G·ª≠i ƒë∆°n"; }
}

function showOrders(){
  const modal = document.getElementById("orderModal");
  const orderList = document.getElementById("orderList");
  orderList.innerHTML="";
  if(sentOrders.length===0) orderList.innerHTML="<p>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>";
  else sentOrders.forEach(order=>{
    const div = document.createElement("div");
    div.style.borderBottom="1px solid #eee";
    div.style.padding="0.4rem 0";
    div.innerHTML=`<strong>M√£ ƒë∆°n: ${order.id||"?"}</strong><br>`+
                  order.items.map(i=>`${i.quantity} x ${i.name} = ${(i.price*i.quantity).toLocaleString()}ƒë`).join("<br>")+
                  `<br><em>${order.time}</em><br><strong>T·ªïng: ${order.total.toLocaleString()}ƒë</strong>`;
    orderList.appendChild(div);
  });
  modal.style.display="flex";
}

function closeModal(){ document.getElementById("orderModal").style.display="none"; }

renderMenu();
</script>


</body>
</html>
