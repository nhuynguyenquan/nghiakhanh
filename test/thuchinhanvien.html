<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Quản lý thu chi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #f5f5f5; }
    h2 { color: #2c3e50; }
    select, table, th, td {
      width: 100%; padding: 8px; margin-top: 10px; font-size: 1rem;
    }
    table { border-collapse: collapse; background: white; margin-top: 1rem; }
    th { background: #3498db; color: white; }
    td, th { border: 1px solid #ddd; text-align: left; }
    .income { color: green; }
    .expense { color: red; }
  </style>
</head>
<body>
  <h2>Danh sách thu chi cá nhân</h2>
  <label for="month">Chọn tháng:</label>
  <select id="month" onchange="renderFiltered()"></select>
  <div id="status" style="margin-top:10px; color: gray;"></div>
  <table id="transTable">
    <thead>
      <tr>
        <th>Ngày</th>
        <th>Loại</th>
        <th>Số tiền</th>
        <th>Ghi chú</th>
      </tr>
    </thead>
    <tbody id="transBody"></tbody>
  </table>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbytwJTEigvy76zh6fkOHMexRS5nr_UxyWBn1H0tOK_PXUf7nnuWILnOZJ6MIzdSJ8NM/exec";

    let allTransactions = [];

    async function getTransactions() {
      const id = localStorage.getItem("id");
      const token = localStorage.getItem("token");

      if (!id || !token) {
        document.getElementById("status").textContent = "Vui lòng đăng nhập lại.";
        return;
      }

      document.getElementById("status").textContent = "Đang tải dữ liệu...";

      const payload = {
        action: "get_transactions",
        id,
        token
      };

      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (result.success) {
          allTransactions = result.data || [];
          renderMonthOptions();
          renderFiltered();
          document.getElementById("status").textContent = "Tải dữ liệu thành công.";
        } else {
          document.getElementById("status").textContent = "Không thể tải dữ liệu: " + result.message;
        }
      } catch (e) {
        document.getElementById("status").textContent = "Lỗi khi kết nối server.";
      }
    }

    function renderMonthOptions() {
      const months = [...new Set(allTransactions.map(t => t.date.slice(0, 7)))];
      const monthSelect = document.getElementById("month");
      monthSelect.innerHTML = "";
      months.sort().reverse().forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        monthSelect.appendChild(opt);
      });
    }

    function renderFiltered() {
      const selectedMonth = document.getElementById("month").value;
      const body = document.getElementById("transBody");
      body.innerHTML = "";

      const filtered = allTransactions.filter(t => t.date.startsWith(selectedMonth));

      filtered.forEach(t => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.date}</td>
          <td class="${t.type}">${t.type === 'income' ? 'Thu' : 'Chi'}</td>
          <td>${parseInt(t.amount).toLocaleString()} đ</td>
          <td>${t.note || ''}</td>
        `;
        body.appendChild(row);
      });

      if (filtered.length === 0) {
        body.innerHTML = `<tr><td colspan="4" style="text-align:center">Không có dữ liệu cho tháng này.</td></tr>`;
      }
    }

    // Tự động tải dữ liệu khi trang mở
    getTransactions();
  </script>
</body>
</html>
