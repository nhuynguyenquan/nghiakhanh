<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Qu·∫£n l√Ω b√°n h√†ng Nh·ª•y Nguy√™n</title>
<style>
html{-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:16px;line-height:1.4;background:#f4f4f4;padding:1rem;margin:0}
h1,h2,h3{color:#2c3e50}
.branch{background:white;border-radius:8px;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
table{width:100%;border-collapse:collapse;table-layout:fixed;margin-top:10px}
th,td{border:1px solid #ddd;padding:6px;text-align:left}
th{background:#f0f0f0}
input,button,select{padding:6px;margin:2px}
.form-group{margin-top:10px}
nav{display:flex;flex-wrap:wrap;justify-content:center;background-color:#d9a382;padding:8px 5px;gap:8px}
nav a{color:white;text-decoration:none;font-size:16px;padding:6px 10px;text-align:center;flex-shrink:0}
@media(max-width:480px){nav a{font-size:14px;padding:4px 6px}}
.month-section{border:1px solid #ccc;border-radius:6px;margin:1rem 0;background:white;box-shadow:0 1px 4px rgba(0,0,0,0.1)}
.month-header{padding:10px;background:#d9a382;color:white;cursor:pointer;font-weight:bold}
.month-content{display:none;padding:10px;overflow-x:auto}
.month-content table{width:100%;border-collapse:collapse;min-width:600px}
.month-content th,.month-content td{padding:6px 8px;text-align:left;white-space:nowrap;border:1px solid #ddd}
@media(max-width:600px){
table,thead,tbody,th,td,tr{display:block}
thead{display:none}
tr{margin-bottom:0.1rem;border:1px solid #ddd;border-radius:3px;padding:3px;background:white}
td{display:flex;flex-direction:column;align-items:center;justify-content:center;border:none;padding:2px 0;min-height:9px;text-align:center;white-space:normal}
td::before{content:attr(data-label);font-weight:bold;color:#555;margin-bottom:2px;text-align:left;width:75%}
input,button,select{width:100%;box-sizing:border-box;margin:3px 0;font-size:1rem}
.form-group{margin-top:6px}}
</style>
</head>
<body>

<nav>
  <a href="../quan-li-thu-chi/">Qu·∫£n L√≠ Thu Chi</a>
  <a href="../quan-li-kho/">Qu·∫£n L√≠ kho</a>
  <a href="../quan-li-menu/">Qu·∫£n L√≠ Menu</a>
  <a href="../quan-li-nv">Qu·∫£n l√≠ nh√¢n vi√™n</a>
  <a href="../quan-li-sx">Qu·∫£n l√≠ s·∫£n xu·∫•t</a>
  <a href="../quan-li-chi-nhanh/">Qu·∫£n L√≠ Chi Nh√°nh</a>
</nav>

<h1>üìä Qu·∫£n l√Ω b√°n h√†ng - Nh·ª•y Nguy√™n</h1>

<div>
  <h2>üìà B√°o c√°o t·ªïng h·ª£p</h2>
  <div id="report"></div>
</div>

<div>
  <h2>‚ûï Th√™m chi nh√°nh m·ªõi</h2>
  <input id="newBranchName" placeholder="T√™n chi nh√°nh">
  <button onclick="addBranch()">Th√™m chi nh√°nh</button>
</div>

<hr>

<div>
  <label>L·ªçc theo ng√†y: <input type="date" id="filterDate" onchange="renderReport()"></label>
</div>

<hr>

<div id="branches"></div>

<script>
const SCRIPT_URL='https://script.google.com/macros/s/AKfycbzfd_pHMmc9qGXJ4iT2LYXg78-WSxXVTHr5O0EeGcs5pa4RlZMB2Gs1xETul4XI-hPFTw/exec';
const TELEGRAM_TOKEN='7783089403:AAGNpG6GsdlF7VXVfPTW8Y1xQJEqBahL1PY';
const CHAT_ID='6249154937';
let salesData={branches:[],logs:[],pins:{}};

async function fetchSalesData(){
  const res=await fetch(SCRIPT_URL);
  salesData=await res.json();
  salesData.logs.forEach(log=>{if(!log.type)log.type='sale'});
  renderBranches();
  renderReport();
}

function renderBranches(){
  const container=document.getElementById('branches');
  container.innerHTML='';
  salesData.branches.forEach((branch,bIndex)=>{
    const div=document.createElement('div');
    div.className='branch';
    let html=`<h2>${branch.name}</h2>
    <div>
      <label>M√£ PIN: 
        <input type="password" id="pin-${bIndex}" value="${branch.pin||''}" onchange="editPin(${bIndex},this.value)">
      </label>
      <button onclick="togglePin(${bIndex})">üëÅÔ∏è</button>
    </div>`;
    html+=`<table><tr><th>M√≥n</th><th>ƒê∆°n v·ªã</th><th>T·ªìn kho</th><th>Gi√°</th><th>B√°n</th><th>Tr·ª´ l·ªói</th><th></th></tr>`;
    branch.menu.forEach((item,iIndex)=>{
      html+=`<tr id="row-${bIndex}-${iIndex}">
        <td><input value="${item.name}" onchange="editItem(${bIndex},${iIndex},'name',this.value)"></td>
        <td><input value="${item.unit||''}" onchange="editItem(${bIndex},${iIndex},'unit',this.value)"></td>
        <td id="stock-${bIndex}-${iIndex}">${item.stock}</td>
        <td><input type="number" value="${item.price}" onchange="editItem(${bIndex},${iIndex},'price',this.value)"></td>
        <td><input type="number" id="sell-${bIndex}-${iIndex}" min="1" max="${item.stock}"></td>
        <td><input type="number" id="waste-${bIndex}-${iIndex}" min="0" placeholder="B·ªã l·ªói"></td>
        <td>
          <button onclick="sell(${bIndex},${iIndex})">B√°n</button>
          <button onclick="waste(${bIndex},${iIndex})">Tr·ª´ l·ªói</button>
          <button onclick="deleteItem(${bIndex},${iIndex})">üóë</button>
          <button onclick="moveItem(${bIndex},${iIndex},-1)">‚¨ÜÔ∏è</button>
          <button onclick="moveItem(${bIndex},${iIndex},1)">‚¨áÔ∏è</button>
        </td>
      </tr>`;
    });
    html+=`</table>
    <div class="form-group">
      <h4>‚ûï Th√™m m√≥n</h4>
      <input placeholder="T√™n m√≥n" id="new-name-${bIndex}">
      <input placeholder="ƒê∆°n v·ªã" id="new-unit-${bIndex}">
      <input placeholder="T·ªìn kho" type="number" id="new-stock-${bIndex}">
      <input placeholder="Gi√°" type="number" id="new-price-${bIndex}">
      <button onclick="addItem(${bIndex})">Th√™m</button>
    </div>`;
    container.appendChild(div);
    div.innerHTML=html;
  });
}

function updateStock(bIndex,iIndex){
  document.getElementById(`stock-${bIndex}-${iIndex}`).innerText=salesData.branches[bIndex].menu[iIndex].stock;
}

function sell(bIndex,iIndex){
  const input=document.getElementById(`sell-${bIndex}-${iIndex}`);
  const qty=parseInt(input.value);
  const item=salesData.branches[bIndex].menu[iIndex];
  if(!qty||qty<=0||qty>item.stock)return alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.');
  item.stock-=qty;
  salesData.logs.push({branch:salesData.branches[bIndex].name,item:item.name,unit:item.unit||'',quantity:qty,price:item.price,type:'sale',time:new Date().toISOString()});
  updateStock(bIndex,iIndex);
  input.value='';
  sendTelegram(`ƒê√£ b√°n ${qty} ${item.unit||''} ${item.name} t·∫°i ${salesData.branches[bIndex].name}`);
  saveData();
}

function waste(bIndex,iIndex){
  const input=document.getElementById(`waste-${bIndex}-${iIndex}`);
  const qty=parseInt(input.value);
  const item=salesData.branches[bIndex].menu[iIndex];
  if(!qty||qty<=0||qty>item.stock)return alert('S·ªë l∆∞·ª£ng tr·ª´ l·ªói kh√¥ng h·ª£p l·ªá.');
  item.stock-=qty;
  salesData.logs.push({branch:salesData.branches[bIndex].name,item:item.name,unit:item.unit||'',quantity:qty,price:0,type:'waste',time:new Date().toISOString()});
  updateStock(bIndex,iIndex);
  input.value='';
  sendTelegram(`Tr·ª´ ${qty} ${item.unit||''} ${item.name} do b·ªã l·ªói t·∫°i ${salesData.branches[bIndex].name}`);
  saveData();
}

function renderReport(){
  const report=document.getElementById('report');
  const filterDate=document.getElementById('filterDate').value;
  const grouped={};
  salesData.logs.forEach(log=>{
    if(!log.type)log.type='sale';
    if(filterDate&&log.time.slice(0,10)!==filterDate)return;
    const month=log.time.slice(0,7);
    const date=log.time.slice(0,10);
    if(!grouped[month])grouped[month]={total:0,days:{}};
    if(!grouped[month].days[date])grouped[month].days[date]=[];
    grouped[month].days[date].push(log);
    if(log.type==='sale')grouped[month].total+=log.price*log.quantity;
  });
  let html='';
  const months=Object.keys(grouped).sort((a,b)=>b.localeCompare(a));
  if(months.length===0){report.innerText='Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.';return;}
  months.forEach((month,index)=>{
    const monthId=`month-${index}`;
    html+=`<div class="month-section">
      <div class="month-header" onclick="toggleMonth('${monthId}')">Th√°ng ${month} - T·ªïng: ${grouped[month].total.toLocaleString()}‚Ç´</div>
      <div class="month-content" id="${monthId}">`;
    const days=Object.keys(grouped[month].days).sort((a,b)=>b.localeCompare(a));
    days.forEach(date=>{
      let dayTotal=0,rows='';
      grouped[month].days[date].forEach(log=>{
        const amount=log.price*log.quantity;
        if(log.type==='sale')dayTotal+=amount;
        rows+=`<tr>
          <td data-label="Chi nh√°nh">${log.branch}</td>
          <td data-label="M√≥n">${log.item}</td>
          <td data-label="S·ªë l∆∞·ª£ng">${log.quantity}</td>
          <td data-label="ƒê∆°n gi√°">${log.price}</td>
          <td data-label="Lo·∫°i">${log.type||'b√°n h√†ng'}</td>
          <td data-label="Th·ªùi gian">${log.time}</td>
        </tr>`;
      });
      html+=`<h4>${date} - T·ªïng: ${dayTotal.toLocaleString()}‚Ç´</h4>
        <table><tr><th>Chi nh√°nh</th><th>M√≥n</th><th>S·ªë l∆∞·ª£ng</th><th>ƒê∆°n gi√°</th><th>Lo·∫°i</th><th>Th·ªùi gian</th></tr>${rows}</table>`;
    });
    html+=`</div></div>`;
  });
  report.innerHTML=html;
}

function toggleMonth(id){
  const el=document.getElementById(id);
  el.style.display=(el.style.display==='none'||el.style.display==='')?'block':'none';
}

function editItem(bIndex,iIndex,key,value){
  if(key==='price'||key==='stock')value=parseInt(value);
  salesData.branches[bIndex].menu[iIndex][key]=value;
  if(key==='stock')updateStock(bIndex,iIndex);
  saveData();
}

function deleteItem(bIndex,iIndex){
  if(confirm('X√≥a m√≥n n√†y?')){
    salesData.branches[bIndex].menu.splice(iIndex,1);
    saveData();
    renderBranches();
  }
}

function moveItem(bIndex,iIndex,delta){
  const arr=salesData.branches[bIndex].menu;
  const newIndex=iIndex+delta;
  if(newIndex<0||newIndex>=arr.length)return;
  [arr[iIndex],arr[newIndex]]=[arr[newIndex],arr[iIndex]];
  saveData();
  renderBranches();
}

function addItem(bIndex){
  const name=document.getElementById(`new-name-${bIndex}`).value;
  const unit=document.getElementById(`new-unit-${bIndex}`).value;
  const stock=parseInt(document.getElementById(`new-stock-${bIndex}`).value)||0;
  const price=parseInt(document.getElementById(`new-price-${bIndex}`).value)||0;
  if(!name)return alert('T√™n m√≥n tr·ªëng');
  salesData.branches[bIndex].menu.push({name,unit,stock,price});
  saveData();
  renderBranches();
}

function addBranch(){
  const name=document.getElementById('newBranchName').value;
  if(!name)return alert('T√™n chi nh√°nh tr·ªëng');
  salesData.branches.push({name,menu:[],pin:''});
  saveData();
  renderBranches();
}

function editPin(bIndex,value){salesData.branches[bIndex].pin=value; saveData();}
function togglePin(bIndex){const input=document.getElementById(`pin-${bIndex}`);input.type=input.type==='password'?'text':'password';}

async function saveData(){
  await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(salesData),headers:{'Content-Type':'application/json'}});
  renderReport();
}

function sendTelegram(msg){
  fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(msg)}`);
}

fetchSalesData();
</script>
</body>
</html>
